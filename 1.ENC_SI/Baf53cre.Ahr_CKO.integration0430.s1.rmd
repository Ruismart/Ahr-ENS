---
output: 
  html_document: 
    toc: yes
    toc_depth: 4
    toc_float: yes
---


# sn-ENS neuron integration   



```{r message=FALSE, warning=FALSE}
source("/Shared_win/projects/RNA_normal/analysis.10x.r")
```


## load processed obj        


```{r}
GEX.seur <- readRDS("./sn10x_SZJ.sct_anno.rds")
GEX.seur
```


```{r}
DefaultAssay(GEX.seur) <- 'integrated'
DefaultAssay(GEX.seur)
```



### filtering and re-clustering            


```{r}
GEX.seur <- subset(GEX.seur, subset= seurat_clusters %in% c(0:29))
GEX.seur <- subset(GEX.seur, subset= percent.mt <1.5)
GEX.seur <- subset(GEX.seur, subset= (cnt %in% c("Stst.CTL","Stst.CKO") & nFeature_RNA > 500 & nFeature_RNA < 1800 & nCount_RNA < 4000) |
                                     (cnt %in% c("CR7d.CTL","CR7d.CKO") & nFeature_RNA > 800 & nFeature_RNA < 2100 & nCount_RNA < 5000))
GEX.seur
```


```{r}
length(GEX.seur@assays$integrated@var.features)
```


```{r}
GEX.seur <- ScaleData(object = GEX.seur, verbose = TRUE, 
                         vars.to.regress = c("percent.mt","percent.rb","nCount_RNA"))
```


```{r}
GEX.seur <- RunPCA(GEX.seur, do.print = TRUE,
                      features = GEX.seur@assays$integrated@var.features,
                      seed.use = 133,
                      npcs = 100,
                      #ndims.print = 1,
                      verbose = T)
```


```{r fig.width=12,fig.height=18}
DimHeatmap(GEX.seur, dims = 1:12, cells = 1500, balanced = TRUE,ncol = 4)
```


```{r}
ElbowPlot(GEX.seur, ndims = 100)
```


```{r}
ElbowPlot(GEX.seur, ndims = 50)
```


```{r}
#
PCsct <- 1:18

GEX.seur <- FindNeighbors(GEX.seur, k.param = 20, dims = PCsct, compute.SNN = T, reduction = 'pca', verbose = T)
GEX.seur <- FindClusters(GEX.seur, dims.use = PCsct, algorithm = 1, save.SNN =T, resolution = 2, reduction = 'pca', verbose = T)
```


```{r}
GEX.seur <- RunTSNE(object = GEX.seur, assay = "integrated", seed.use = 233, dims = PCsct, complexity=100)
GEX.seur <- RunUMAP(object = GEX.seur, assay = "integrated", seed.use = 166, dims = PCsct, n.neighbors = 20, min.dist = 0.3)
```



```{r fig.width=11.5, fig.height=4.5}
DimPlot(GEX.seur, label = T, pt.size = 0.05, repel = F, reduction = 'tsne', group.by = "seurat_clusters") +
DimPlot(GEX.seur, label = T, pt.size = 0.05, repel = F, reduction = 'umap', group.by = "seurat_clusters")
```


```{r fig.width=10.8, fig.height=4.5}
DimPlot(GEX.seur, label = T, pt.size = 0.05, repel = F, reduction = 'tsne', group.by = "Anno1") +
DimPlot(GEX.seur, label = T, pt.size = 0.05, repel = F, reduction = 'umap', group.by = "Anno1")
```


```{r fig.width=10.8, fig.height=4.5}
DimPlot(GEX.seur, label = T, pt.size = 0.05, repel = F, reduction = 'tsne', group.by = "Anno2") +
DimPlot(GEX.seur, label = T, pt.size = 0.05, repel = F, reduction = 'umap', group.by = "Anno2")
```


```{r}
color.cnt <- scales::hue_pal()(4)[c(2,1,3,4)]
color.cnt
```


```{r  fig.width=12.6, fig.height=3.9}
DimPlot(GEX.seur, label = F, pt.size = 0.05, repel = F, reduction = 'umap', group.by = "cnt", split.by = "cnt", ncol = 4, cols = color.cnt)
```



```{r fig.width=10.8, fig.height=4.5}
DimPlot(GEX.seur, label = T, pt.size = 0.05, repel = F, reduction = 'umap', group.by = "Anno1") +
DimPlot(GEX.seur, label = F, pt.size = 0.05, repel = F, reduction = 'umap', group.by = "cnt",cols = color.cnt)
```


```{r fig.width=10.8, fig.height=4.5}
DimPlot(subset(GEX.seur, subset = cnt %in% c("Stst.CTL","Stst.CKO")), label = F, pt.size = 0.05, repel = F, reduction = 'umap', group.by = "cnt", cols = color.cnt[1:2]) +
DimPlot(subset(GEX.seur, subset = cnt %in% c("CR7d.CTL","CR7d.CKO")), label = F, pt.size = 0.05, repel = F, reduction = 'umap', group.by = "cnt", cols = color.cnt[3:4])
```

```{r fig.width=7.5,fig.height=6}
FeaturePlot(GEX.seur, 
            reduction = "umap", features = c("nFeature_RNA","nCount_RNA","percent.mt","percent.rb"))
FeaturePlot(subset(GEX.seur, subset = cnt %in% c("Stst.CTL","Stst.CKO")),
            reduction = "umap", features = c("nFeature_RNA","nCount_RNA","percent.mt","percent.rb"))
FeaturePlot(subset(GEX.seur, subset = cnt %in% c("CR7d.CTL","CR7d.CKO")), 
            reduction = "umap", features = c("nFeature_RNA","nCount_RNA","percent.mt","percent.rb"))
```


```{r fig.width=10.8, fig.height=4.5}
(DimPlot(subset(GEX.seur,subset=cnt %in% c("Stst.CTL","Stst.CKO")), label = T, pt.size = 0.05, repel = F, reduction = 'umap', group.by = "Anno1")+labs(title="Stst only")) +
(DimPlot(subset(GEX.seur,subset=cnt %in% c("CR7d.CTL","CR7d.CKO")), label = T, pt.size = 0.05, repel = F, reduction = 'umap', group.by = "Anno1")+labs(title="CR7d only"))
```

```{r fig.width=10.8, fig.height=4.5}
(DimPlot(subset(GEX.seur,subset=cnt %in% c("Stst.CTL","Stst.CKO")), label = T, pt.size = 0.05, repel = F, reduction = 'umap', group.by = "seurat_clusters")+labs(title="Stst only")) +
(DimPlot(subset(GEX.seur,subset=cnt %in% c("CR7d.CTL","CR7d.CKO")), label = T, pt.size = 0.05, repel = F, reduction = 'umap', group.by = "seurat_clusters")+labs(title="CR7d only"))
```


```{r fig.width=10.8, fig.height=4.5}
(DimPlot(subset(GEX.seur,subset=cnt %in% c("Stst.CTL","Stst.CKO")), label = T, pt.size = 0.05, repel = F, reduction = 'umap', group.by = "Anno1")+labs(title="Stst only")) +
(DimPlot(subset(GEX.seur,subset=cnt %in% c("Stst.CTL","Stst.CKO")), label = T, pt.size = 0.05, repel = F, reduction = 'umap', group.by = "seurat_clusters")+labs(title="Stst only"))
```


```{r fig.width=10.8, fig.height=4.5}
(DimPlot(subset(GEX.seur,subset=cnt %in% c("CR7d.CTL","CR7d.CKO")), label = T, pt.size = 0.05, repel = F, reduction = 'umap', group.by = "Anno1")+labs(title="CR7d only")) +
(DimPlot(subset(GEX.seur,subset=cnt %in% c("CR7d.CTL","CR7d.CKO")), label = T, pt.size = 0.05, repel = F, reduction = 'umap', group.by = "seurat_clusters")+labs(title="CR7d only"))
```


#### sort_clusters           


```{r}
GEX.seur$sort_clusters <- factor(as.character(GEX.seur$seurat_clusters),
                                 levels = c(3,0,7,8, 14, 13, 9, 1, 17,
                                            6,5,2,4, 12, 16, 23,
                                            10, 19,25, 22,
                                            18,11, 15,21, 24, 20))
```


```{r fig.width=12, fig.height=6}
VlnPlot(subset(GEX.seur, subset = cnt %in% c("Stst.CTL","Stst.CKO")), 
        features = c("nFeature_RNA", "nCount_RNA", "percent.mt","percent.rb"), ncol = 2, pt.size = 0.01, group.by = "sort_clusters")
VlnPlot(subset(GEX.seur, subset = cnt %in% c("CR7d.CTL","CR7d.CKO")), 
        features = c("nFeature_RNA", "nCount_RNA", "percent.mt","percent.rb"), ncol = 2, pt.size = 0.01, group.by = "sort_clusters")
```


#### previous markers        


```{r}
DefaultAssay(GEX.seur) <- "SCT"
DefaultAssay(GEX.seur)
```



```{r fig.height=5.5, fig.width=18.5}
markers.new.ss <- list(EMN=c("Chat","Bnc2","Tox","Ptprt",
                       "Gfra2","Oprk1","Adamtsl1", 
                       "Fbxw15","Fbxw24","Chrna7",
                       "Satb1","Itga6","Cntnap5b",
                       "Pgm5","Chgb",
                       "Nxph1",
                       "Gabrb1","Glp2r","Nebl",
                       "Lrrc7",
                       "Ryr3","Eda",
                       "Hgf","Lama2","Efnb2",
                       "Tac1",
                       "Kctd8",
                       "Ptn",
                       "Ntrk2","Penk","Itgb8",
                       "Fut9","Nfatc1","Egfr","Pdia5",
                       "Ahr","Mgll",
                       "Aff3",
                       "Chrm3"
                       ),
                 IMN=c("Nos1","Kcnab1",
                       "Gfra1","Etv1",
                       "Man1a","Airn",
                       "Adcy2",
                       "Col25a1",
                       "Cmah","Creb5","Vip","Pde1a",
                       "Ebf1","Gpc5","Mid1","Igfbp5",
                       "Ppara",
                       "Pcdh11x","Adcy8","Grp"
                       ),
                 IN=c("Npas3","Synpr","St18","Gal",
                      "Nova1",
                      "Cdh10","Kcnk13",
                      "Neurod6","Moxd1","Sctr",
                      "Piezo1","Vipr2","Adamts9","Sst","Kcnn2"
                      ),
                 IPAN=c("Calb2","Adcy1","Calcb","Nmu","Adgrg6","Pcdh10",
                        "Ngfr","Galr1","Il7","Aff2",
                        "Gpr149","Itgb6","Met","Itgbl1",
                        
                        "Cdh6","Cdh8",
                        "Clstn2","Ano2","Ntrk3",
                        "Cpne4","Vwc2l","Cdh9",
                        "Car10","Dcc",
                        "Scgn",
                        "Vcan","Cck","Piezo2","Kcnh7",
                        "Rerg","Bmpr1b","Skap1","Ntng1",
                        "Tafa2","Nxph2"),
                 CONTAM=c("Actl6b","Phox2b"), #,"Sox10","Plp1","L1cam","Gfap","Rxrg","Acta2","Actg2","Epcam","Pecam1","Ptprc"
                 pDEGs=c("Grid2","Ide","Btaf1","Slc15a2","Ccser1","Hdac9","Rspo2","Grem2"))

#
pm.All_new.s2 <- DotPlot(GEX.seur, features = as.vector(unlist(markers.new.ss)), group.by = "sort_clusters",
        cols = c("midnightblue","darkorange1")) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1,size = 9.15))+ scale_y_discrete(limits=rev) #+ labs(title="All - newAnno1")
pm.All_new.s2



```

C25 ?            


```{r}
table(GEX.seur@meta.data[,c("sample","sort_clusters")])
```
        

I perfer to remove C25 which might be a rare new subtype, but here more like a contaminated mix in IN2                  
            
              
```{r}
GEX.seur <- subset(GEX.seur, subset = seurat_clusters != c(25))
GEX.seur
```
      
```{r paged.print=FALSE}
#
GEX.seur@meta.data[,grep("Anno|snn",colnames(GEX.seur@meta.data),value = T)] <- NULL
head(GEX.seur@meta.data)
```
      
      
      
## intAnno                    


```{r}
# intAnno1 
GEX.seur$intAnno1 <- as.character(GEX.seur$seurat_clusters)

GEX.seur$intAnno1[GEX.seur$intAnno1 %in% c(3,0,7,8,14)] <- "EMN1"
GEX.seur$intAnno1[GEX.seur$intAnno1 %in% c(13)] <- "EMN2"
GEX.seur$intAnno1[GEX.seur$intAnno1 %in% c(9)] <- "EMN3"
GEX.seur$intAnno1[GEX.seur$intAnno1 %in% c(1)] <- "EMN4"
GEX.seur$intAnno1[GEX.seur$intAnno1 %in% c(17)] <- "EMN5"

GEX.seur$intAnno1[GEX.seur$intAnno1 %in% c(6,5,2,4)] <- "IMN1"
GEX.seur$intAnno1[GEX.seur$intAnno1 %in% c(12)] <- "IMN2"
GEX.seur$intAnno1[GEX.seur$intAnno1 %in% c(16)] <- "IMN3"
GEX.seur$intAnno1[GEX.seur$intAnno1 %in% c(23)] <- "IMN4"

GEX.seur$intAnno1[GEX.seur$intAnno1 %in% c(10)] <- "IN1"
GEX.seur$intAnno1[GEX.seur$intAnno1 %in% c(19)] <- "IN2"
GEX.seur$intAnno1[GEX.seur$intAnno1 %in% c(22)] <- "IN3"

GEX.seur$intAnno1[GEX.seur$intAnno1 %in% c(18,11)] <- "IPAN1"
GEX.seur$intAnno1[GEX.seur$intAnno1 %in% c(15,21)] <- "IPAN2"
GEX.seur$intAnno1[GEX.seur$intAnno1 %in% c(24)] <- "IPAN3"
GEX.seur$intAnno1[GEX.seur$intAnno1 %in% c(20)] <- "IPAN4"

GEX.seur$intAnno1 <- factor(GEX.seur$intAnno1,
                            levels = c(paste0("EMN",1:5),
                                       paste0("IMN",1:4),
                                       paste0("IN",1:3),
                                       paste0("IPAN",1:4)))

# intAnno2
GEX.seur$intAnno2 <- as.character(GEX.seur$seurat_clusters)

GEX.seur$intAnno2[GEX.seur$intAnno2 %in% c(3,0,7,8,14)] <- "EMN1"
GEX.seur$intAnno2[GEX.seur$intAnno2 %in% c(13)] <- "EMN2"
GEX.seur$intAnno2[GEX.seur$intAnno2 %in% c(9)] <- "EMN3"
GEX.seur$intAnno2[GEX.seur$intAnno2 %in% c(1)] <- "EMN4"
GEX.seur$intAnno2[GEX.seur$intAnno2 %in% c(17)] <- "EMN5"

GEX.seur$intAnno2[GEX.seur$intAnno2 %in% c(6,5,2,4)] <- "IMN1"
GEX.seur$intAnno2[GEX.seur$intAnno2 %in% c(12)] <- "IMN2"
GEX.seur$intAnno2[GEX.seur$intAnno2 %in% c(16)] <- "IMN3"
GEX.seur$intAnno2[GEX.seur$intAnno2 %in% c(23)] <- "IMN4"

GEX.seur$intAnno2[GEX.seur$intAnno2 %in% c(10)] <- "IN1"
GEX.seur$intAnno2[GEX.seur$intAnno2 %in% c(19)] <- "IN2"
GEX.seur$intAnno2[GEX.seur$intAnno2 %in% c(22)] <- "IN3"

GEX.seur$intAnno2[GEX.seur$intAnno2 %in% c(18)] <- "IPAN1.1"
GEX.seur$intAnno2[GEX.seur$intAnno2 %in% c(11)] <- "IPAN1.2"
GEX.seur$intAnno2[GEX.seur$intAnno2 %in% c(15)] <- "IPAN2.1"
GEX.seur$intAnno2[GEX.seur$intAnno2 %in% c(21)] <- "IPAN2.2"
GEX.seur$intAnno2[GEX.seur$intAnno2 %in% c(24)] <- "IPAN3"
GEX.seur$intAnno2[GEX.seur$intAnno2 %in% c(20)] <- "IPAN4"

GEX.seur$intAnno2 <- factor(GEX.seur$intAnno2,
                            levels = c(paste0("EMN",1:5),
                                       paste0("IMN",1:4),
                                       paste0("IN",1:3),
                                       paste0("IPAN",c(1.1,1.2,2.1,2.2,3,4))))


```


```{r}
#saveRDS(GEX.seur, "./sn10x_SZJ.sct_anno.s.rds")
#GEX.seur <- readRDS("./sn10x_SZJ.sct_anno.s.rds")
```


```{r fig.width=11.5, fig.height=4.5}
pp.umap1 <- DimPlot(GEX.seur, label = T, pt.size = 0.05, repel = F, reduction = 'tsne', group.by = "seurat_clusters") +
DimPlot(GEX.seur, label = T, pt.size = 0.05, repel = F, reduction = 'umap', group.by = "seurat_clusters")
pp.umap1
```


```{r eval=FALSE, include=FALSE}
ggsave("./composition/Baf53cre_CR.integ.umap1.pdf",
       width = 11.5, height = 4.5,
       plot = pp.umap1)
```


```{r fig.width=10.8, fig.height=4.5}
pp.umap2 <- DimPlot(GEX.seur, label = T, pt.size = 0.05, repel = F, reduction = 'umap', group.by = "intAnno1") +
DimPlot(GEX.seur, label = T, label.size = 2.65, pt.size = 0.05, repel = F, reduction = 'umap', group.by = "intAnno2")
pp.umap2 
```

```{r eval=FALSE, include=FALSE}
ggsave("./composition/Baf53cre_CR.integ.umap2.pdf",
       width = 10.8, height = 4.5,
       plot = pp.umap2)
```


```{r  fig.width=12.6, fig.height=3.9}
pp.umap3 <- DimPlot(GEX.seur, label = F, pt.size = 0.05, repel = F, reduction = 'umap', group.by = "cnt", split.by = "cnt", ncol = 4, cols = color.cnt)
pp.umap3
```


```{r eval=FALSE, include=FALSE}
ggsave("./composition/Baf53cre_CR.integ.umap3.pdf",
       width = 12.6, height = 3.9,
       plot = pp.umap3)
```


#### dotplot             

```{r}
markers.new.ss <- list(EMN=c("Chat","Bnc2","Tox","Ptprt",
                       "Gfra2","Oprk1","Adamtsl1", 
                       "Fbxw15","Fbxw24","Chrna7",
                       "Satb1","Itga6","Cntnap5b",
                       "Pgm5","Chgb",
                       "Nxph1",
                       "Gabrb1","Glp2r","Nebl",
                       "Lrrc7",
                       "Ryr3","Eda",
                       "Hgf","Lama2","Efnb2",
                       "Tac1",
                       "Kctd8",
                       "Ptn",
                       "Ntrk2","Penk","Itgb8",
                       "Fut9","Nfatc1","Egfr","Pdia5",
                       "Ahr","Mgll",
                       "Aff3",
                       "Chrm3"
                       ),
                 IMN=c("Nos1","Kcnab1",
                       "Gfra1","Etv1",
                       "Man1a","Airn",
                       "Adcy2",
                       "Col25a1",
                       "Cmah","Creb5","Vip","Pde1a",
                       "Ebf1","Gpc5","Mid1","Igfbp5",
                       "Ppara",
                       "Pcdh11x","Adcy8","Grp"
                       ),
                 IN=c("Npas3","Synpr","St18","Gal",
                      "Nova1",
                      "Cdh10","Kcnk13",
                      "Neurod6","Moxd1","Sctr",
                      "Piezo1","Vipr2","Adamts9","Sst","Kcnn2"
                      ),
                 IPAN=c("Calb2","Adcy1","Calcb","Nmu","Adgrg6","Pcdh10",
                        "Ngfr","Galr1","Il7","Aff2",
                        "Gpr149","Itgb6","Met","Itgbl1",
                        
                        "Cdh6","Cdh8",
                        "Clstn2","Ano2","Ntrk3",
                        "Cpne4","Vwc2l","Cdh9",
                        "Car10","Dcc",
                        "Scgn",
                        "Vcan","Cck","Piezo2","Kcnh7",
                        "Rerg","Bmpr1b","Skap1","Ntng1",
                        "Tafa2","Nxph2"),
                 CONTAM=c("Actl6b","Phox2b"),
                 pDEGs=c("Grid2","Ide","Btaf1","Slc15a2","Ccser1","Hdac9","Rspo2","Grem2"))
```


```{r}
check.markers.ss <- as.vector(unlist(markers.new.ss))
check.markers.ss
```


```{r}
length(check.markers.ss)
sum(check.markers.ss %in% rownames(GEX.seur))
```



```{r fig.height=6.5, fig.width=16.5}

pm.All_new.a <- DotPlot(GEX.seur, features = check.markers.ss, group.by = "sort_clusters",
        cols = c("midnightblue","darkorange1")) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1,size = 9.15))+ scale_y_discrete(limits=rev) + labs(title="All - sort_clusters")
pm.All_new.a

```


```{r eval=FALSE, include=FALSE}
ggsave("./composition/Baf53cre_CR.integ.dotplot.a.pdf",
       width = 20.5, height = 6.5,
       plot = pm.All_new.a)
```


```{r fig.height=5.5, fig.width=16.5}

pm.All_new.b <- DotPlot(GEX.seur, features = check.markers.ss, group.by = "intAnno1",
        cols = c("midnightblue","darkorange1")) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1,size = 9.15))+ scale_y_discrete(limits=rev) + labs(title="All - intAnno1")
pm.All_new.b

```

```{r eval=FALSE, include=FALSE}
ggsave("./composition/Baf53cre_CR.integ.dotplot.b.pdf",
       width = 20.5, height = 5.5,
       plot = pm.All_new.b)
```


```{r fig.height=5.5, fig.width=16.5}

pm.All_new.c <- DotPlot(GEX.seur, features = check.markers.ss, group.by = "intAnno2",
        cols = c("midnightblue","darkorange1")) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1,size = 9.15))+ scale_y_discrete(limits=rev) + labs(title="All - intAnno2")
pm.All_new.c

```

```{r eval=FALSE, include=FALSE}
ggsave("./composition/Baf53cre_CR.integ.dotplot.c.pdf",
       width = 20.5, height = 5.5,
       plot = pm.All_new.c)
```


```{r fig.height=5.5, fig.width=16.5}
#
pm.All_new.c1 <- DotPlot(subset(GEX.seur, subset= cnt %in% c("Stst.CTL")), features = check.markers.ss, group.by = "intAnno2",
        cols = c("midnightblue","darkorange1")) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1,size = 9.15))+ scale_y_discrete(limits=rev) + labs(title="Stst.CTL - intAnno2")
pm.All_new.c1

```


```{r fig.height=5.5, fig.width=16.5}
#
pm.All_new.c2 <- DotPlot(subset(GEX.seur, subset= cnt %in% c("Stst.CKO")), features = check.markers.ss, group.by = "intAnno2",
        cols = c("midnightblue","darkorange1")) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1,size = 9.15))+ scale_y_discrete(limits=rev) + labs(title="Stst.CKO - intAnno2")
pm.All_new.c2

```


```{r fig.height=5.5, fig.width=16.5}
#
pm.All_new.c3 <- DotPlot(subset(GEX.seur, subset= cnt %in% c("CR7d.CTL")), features = check.markers.ss, group.by = "intAnno2",
        cols = c("midnightblue","darkorange1")) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1,size = 9.15))+ scale_y_discrete(limits=rev) + labs(title="CR7d.CTL - intAnno2")
pm.All_new.c3

```


```{r fig.height=5.5, fig.width=16.5}
#
pm.All_new.c4 <- DotPlot(subset(GEX.seur, subset= cnt %in% c("CR7d.CKO")), features = check.markers.ss, group.by = "intAnno2",
        cols = c("midnightblue","darkorange1")) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1,size = 9.15))+ scale_y_discrete(limits=rev) + labs(title="CR7d.CKO - intAnno2")
pm.All_new.c4

```




### new       

```{r}
# define intAnno1/2 colors
color.A1 <- c("#678BB1","#8AB6CE","#3975C1","#669FDF","#4CC1BD",
              "#BF7E6B","#D46B35","#F19258","#FF8080",
              "#BDAE8D","#BD66C4","#C03778",
              "#97BA59","#DFAB16","#2BA956","#9FE727")
names(color.A1) <- levels(GEX.seur$intAnno1)

color.A2 <- c("#678BB1","#8AB6CE","#3975C1","#669FDF","#4CC1BD",
              "#BF7E6B","#D46B35","#F19258","#FF8080",
              "#BDAE8D","#BD66C4","#C03778",
              "#97BA59","#C4D116", "#DFAB16","#EDE25A", "#2BA956","#9FE727")
names(color.A2) <- levels(GEX.seur$intAnno2)

# define batch/condition colors
color.cnt <- scales::hue_pal()(4)[c(2,1,3,4)]
names(color.cnt) <- levels(GEX.seur$cnt)

color.test1 <- color.cnt[1:2]
color.test2 <- color.cnt[3:4]

## define feature colors
# Cell2020     
material.heat = function(n){
  colorRampPalette(
    c(
      "#283593", # indigo 800
      "#3F51B5", # indigo
      "#2196F3", # blue
      "#00BCD4", # cyan
      "#4CAF50", # green
      "#8BC34A", # light green
      "#CDDC39", # lime
      "#FFEB3B", # yellow
      "#FFC107", # amber
      "#FF9800", # orange
      "#FF5722"  # deep orange
    )
  )(n)
}

# Immunity2019, na gray
colors.Immunity <-c("#191970","#121285","#0C0C9A","#0707B0","#0101C5","#0014CF","#0033D3","#0053D8","#0072DD","#0092E1","#00B2E6",
                  "#00D1EB","#23E8CD","#7AF17B","#D2FA29","#FFEB00","#FFC300","#FF9B00","#FF8400","#FF7800","#FF6B00","#FF5F00","#FF5300",
                  "#FF4700","#F73B00","#EF2E00","#E62300","#DD1700","#D50B00","#CD0000")


# NatNeur2021, sc-neurons
color.ref <- c("#8AB6CE","#678BB1","#3975C1","#4CC1BD",
               "#C03778","#97BA59","#DFAB16","#BF7E6B",
               "#D46B35","#BDAE8D","#BD66C4","#2BA956",
               "#FF8080","#FF8080","#FF8080","#FF0000")
```


```{r eval=FALSE, include=FALSE}
write.table(color.A1, "figures.integration/color.A1.txt", col.names = F, row.names = T, quote = F)
write.table(color.A2, "figures.integration/color.A2.txt", col.names = F, row.names = T, quote = F)

write.table(color.cnt, "figures.integration/color.condition.txt", col.names = F, row.names = T, quote = F)
```


```{r fig.width=11.5,fig.height=4.5}
cowplot::plot_grid(
DimPlot(GEX.seur, reduction = "umap", group.by = "intAnno1", label = T, label.size = 3.25,repel = F, pt.size = 0.05,
        cols = color.A1),
  DimPlot(GEX.seur, label = F, pt.size = 0.05, repel = F, reduction = 'umap', group.by = "cnt",
        cols = color.cnt) ,
rel_widths = c(4.8,5),
ncol = 2)
```

```{r fig.width=11.8,fig.height=4.5}
cowplot::plot_grid(
DimPlot(GEX.seur, reduction = "umap", group.by = "intAnno2", label = T, label.size = 2.65,repel = F, pt.size = 0.05,
        cols = color.A2),
  DimPlot(GEX.seur, label = F, pt.size = 0.05, repel = F, reduction = 'umap', group.by = "cnt",
        cols = color.cnt) ,
rel_widths = c(4.85,5),
ncol = 2)
```

```{r eval=FALSE, include=FALSE}
# umap0
pdf("./figures.integration/umap.intAnno1_cnt.all.pdf",
    width = 11.5, height = 4.5)
cowplot::plot_grid(
DimPlot(GEX.seur, reduction = "umap", group.by = "intAnno1", label = T, label.size = 3.25,repel = F, pt.size = 0.05,
        cols = color.A1),
  DimPlot(GEX.seur, label = F, pt.size = 0.05, repel = F, reduction = 'umap', group.by = "cnt",
        cols = color.cnt) ,
rel_widths = c(4.8,5),
ncol = 2)
dev.off()

pdf("./figures.integration/umap.intAnno2_cnt.all.pdf",
    width = 11.8, height = 4.5)
cowplot::plot_grid(
DimPlot(GEX.seur, reduction = "umap", group.by = "intAnno2", label = T, label.size = 2.65,repel = F, pt.size = 0.05,
        cols = color.A2),
  DimPlot(GEX.seur, label = F, pt.size = 0.05, repel = F, reduction = 'umap', group.by = "cnt",
        cols = color.cnt) ,
rel_widths = c(4.85,5),
ncol = 2)
dev.off()
```


### condition                


#### Stst                


```{r}
test1.seur <- subset(GEX.seur, subset= cnt %in% c("Stst.CTL","Stst.CKO"))
test1.seur
```


```{r fig.width=11.5,fig.height=4.5}
cowplot::plot_grid(
DimPlot(test1.seur, reduction = "umap", group.by = "intAnno1", label = T, label.size = 3.25,repel = F, pt.size = 0.15,
        cols = color.A1),
  DimPlot(test1.seur, label = F, pt.size = 0.15, repel = F, reduction = 'umap', group.by = "cnt",
        cols = color.test1) ,
rel_widths = c(4.8,5),
ncol = 2)
```


```{r fig.width=11.8,fig.height=4.5}
cowplot::plot_grid(
DimPlot(test1.seur, reduction = "umap", group.by = "intAnno2", label = T, label.size = 2.65,repel = F, pt.size = 0.15,
        cols = color.A2),
  DimPlot(test1.seur, label = F, pt.size = 0.15, repel = F, reduction = 'umap', group.by = "cnt",
        cols = color.test1) ,
rel_widths = c(4.85,5),
ncol = 2)
```


```{r eval=FALSE, include=FALSE}
# umap0
pdf("./figures.integration/Stst/umap.intAnno1_cnt.Stst_CTLvsCKO.pdf",
    width = 11.5, height = 4.5)
cowplot::plot_grid(
DimPlot(test1.seur, reduction = "umap", group.by = "intAnno1", label = T, label.size = 3.25,repel = F, pt.size = 0.15,
        cols = color.A1),
  DimPlot(test1.seur, label = F, pt.size = 0.05, repel = F, reduction = 'umap', group.by = "cnt",
        cols = color.test1) ,
rel_widths = c(4.8,5),
ncol = 2)
dev.off()

pdf("./figures.integration/Stst/umap.intAnno2_cnt.Stst_CTLvsCKO.pdf",
    width = 11.8, height = 4.5)
cowplot::plot_grid(
DimPlot(test1.seur, reduction = "umap", group.by = "intAnno2", label = T, label.size = 2.65,repel = F, pt.size = 0.15,
        cols = color.A2),
  DimPlot(test1.seur, label = F, pt.size = 0.05, repel = F, reduction = 'umap', group.by = "cnt",
        cols = color.test1) ,
rel_widths = c(4.85,5),
ncol = 2)
dev.off()
```



#### CR7d                


```{r}
test2.seur <- subset(GEX.seur, subset= cnt %in% c("CR7d.CTL","CR7d.CKO"))
test2.seur
```


```{r fig.width=11.5,fig.height=4.5}
cowplot::plot_grid(
DimPlot(test2.seur, reduction = "umap", group.by = "intAnno1", label = T, label.size = 3.25,repel = F, pt.size = 0.15,
        cols = color.A1),
  DimPlot(test2.seur, label = F, pt.size = 0.15, repel = F, reduction = 'umap', group.by = "cnt",
        cols = color.test2) ,
rel_widths = c(4.8,5),
ncol = 2)
```


```{r fig.width=11.8,fig.height=4.5}
cowplot::plot_grid(
DimPlot(test2.seur, reduction = "umap", group.by = "intAnno2", label = T, label.size = 2.65,repel = F, pt.size = 0.15,
        cols = color.A2),
  DimPlot(test2.seur, label = F, pt.size = 0.15, repel = F, reduction = 'umap', group.by = "cnt",
        cols = color.test2) ,
rel_widths = c(4.85,5),
ncol = 2)
```

```{r eval=FALSE, include=FALSE}
# umap0
pdf("./figures.integration/CR7d/umap.intAnno1_cnt.CR7d_CTLvsCKO.pdf",
    width = 11.5, height = 4.5)
cowplot::plot_grid(
DimPlot(test2.seur, reduction = "umap", group.by = "intAnno1", label = T, label.size = 3.25,repel = F, pt.size = 0.15,
        cols = color.A1),
  DimPlot(test2.seur, label = F, pt.size = 0.05, repel = F, reduction = 'umap', group.by = "cnt",
        cols = color.test2) ,
rel_widths = c(4.8,5),
ncol = 2)
dev.off()

pdf("./figures.integration/CR7d/umap.intAnno2_cnt.CR7d_CTLvsCKO.pdf",
    width = 11.8, height = 4.5)
cowplot::plot_grid(
DimPlot(test2.seur, reduction = "umap", group.by = "intAnno2", label = T, label.size = 2.65,repel = F, pt.size = 0.15,
        cols = color.A2),
  DimPlot(test2.seur, label = F, pt.size = 0.05, repel = F, reduction = 'umap', group.by = "cnt",
        cols = color.test2) ,
rel_widths = c(4.85,5),
ncol = 2)
dev.off()
```



## cell composition                  
             
           
### Stst         


```{r fig.width=6.4, fig.height=4.5}
cowplot::plot_grid(
pheatmap::pheatmap(table(cnt=test1.seur$sample,
      clusters=test1.seur$intAnno1)[c(4:6,1:3),],
                   main = "Cell Count",
                   gaps_row = c(3),
      gaps_col = c(5,9,12),
                   cluster_rows = F, cluster_cols = F, display_numbers = T, number_format = "%.0f", legend = F, silent = T)$gtable,

pheatmap::pheatmap(100*rowRatio(table(cnt=test1.seur$sample,
                                clusters=test1.seur$intAnno1)[c(4:6,1:3),] ),
                   main = "Cell Ratio",
                   gaps_row = c(3),
      gaps_col = c(5,9,12),
                   cluster_rows = F, cluster_cols = F, display_numbers = T, number_format = "%.1f", legend = F, silent =T)$gtable,
ncol = 1)
```

```{r fig.width=6.4, fig.height=4.5}
cowplot::plot_grid(
pheatmap::pheatmap(table(cnt=test1.seur$sample,
      clusters=test1.seur$intAnno2)[c(4:6,1:3),],
                   main = "Cell Count",
                   gaps_row = c(3),
      gaps_col = c(5,9,12),
                   cluster_rows = F, cluster_cols = F, display_numbers = T, number_format = "%.0f", legend = F, silent = T)$gtable,

pheatmap::pheatmap(100*rowRatio(table(cnt=test1.seur$sample,
                                clusters=test1.seur$intAnno2)[c(4:6,1:3),] ),
                   main = "Cell Ratio",
                   gaps_row = c(3),
      gaps_col = c(5,9,12),
                   cluster_rows = F, cluster_cols = F, display_numbers = T, number_format = "%.1f", legend = F, silent =T)$gtable,
ncol = 1)
```

#### barplot    


```{r}
stat1_intAnno1 <- test1.seur@meta.data[,c("cnt","rep","intAnno1")]

stat1_intAnno1.s <- stat1_intAnno1 %>%
  group_by(cnt,rep,intAnno1) %>%
  summarise(count=n()) %>%
  mutate(prop= count/sum(count)) %>%
  ungroup
```

```{r eval=FALSE, include=FALSE, paged.print=FALSE}
write.csv(stat1_intAnno1.s %>% reshape2::recast(cnt + rep ~ intAnno1, measure.var = 4), 
          "composition/Baf53cre_CR.integ.Stst.composition_intAnno1.stat_df.count.csv")
write.csv(stat1_intAnno1.s %>% reshape2::recast(cnt + rep ~ intAnno1, measure.var = 5), 
          "composition/Baf53cre_CR.integ.Stst.composition_intAnno1.stat_df.ratio.csv")
```


```{r  fig.height=3.5, fig.width=10.5}
pcom1.intAnno1 <- stat1_intAnno1.s %>%
  ggplot(aes(x = intAnno1, y = 100*prop, color=cnt)) +
  geom_bar(stat="summary", fun="mean", position = position_dodge(0.75), width = 0.58, fill="white") +
  theme_classic(base_size = 15) +
  scale_color_manual(values = color.test1, name="") +
  labs(title="Cell Composition of Stst.CTL_CKO, intAnno1", y = "Proportion") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 9.6)) +
  
  geom_point(aes(x=intAnno1, y = 100*prop, color= cnt),
             position = position_dodge(0.75),
             shape=16,alpha=0.75,size=2.15,
             stroke=0.15, show.legend=F)

pcom1.intAnno1
```


```{r eval=FALSE, include=FALSE}
ggsave("./composition/Baf53cre_CR.integ.Stst.composition_intAnno1.barplot.pdf",
       width = 10.5, height = 3.5,
       plot = pcom1.intAnno1)
```


```{r}
stat1_intAnno2 <- test1.seur@meta.data[,c("cnt","rep","intAnno2")]

stat1_intAnno2.s <- stat1_intAnno2 %>%
  group_by(cnt,rep,intAnno2) %>%
  summarise(count=n()) %>%
  mutate(prop= count/sum(count)) %>%
  ungroup
```


```{r eval=FALSE, include=FALSE, paged.print=FALSE}
write.csv(stat1_intAnno2.s %>% reshape2::recast(cnt + rep ~ intAnno2, measure.var = 4), 
          "composition/Baf53cre_CR.integ.Stst.composition_intAnno2.stat_df.count.csv")
write.csv(stat1_intAnno2.s %>% reshape2::recast(cnt + rep ~ intAnno2, measure.var = 5), 
          "composition/Baf53cre_CR.integ.Stst.composition_intAnno2.stat_df.ratio.csv")
```


```{r  fig.height=3.5, fig.width=10.5}
pcom1.intAnno2 <- stat1_intAnno2.s %>%
  ggplot(aes(x = intAnno2, y = 100*prop, color=cnt)) +
  geom_bar(stat="summary", fun="mean", position = position_dodge(0.75), width = 0.58, fill="white") +
  theme_classic(base_size = 15) +
  scale_color_manual(values = color.test1, name="") +
  labs(title="Cell Composition of Stst.CTL_CKO, intAnno2", y = "Proportion") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 9.6)) +
  
  geom_point(aes(x=intAnno2, y = 100*prop, color= cnt),
             position = position_dodge(0.75),
             shape=16,alpha=0.75,size=2.15,
             stroke=0.15, show.legend=F)

pcom1.intAnno2
```

```{r eval=FALSE, include=FALSE}
ggsave("./composition/Baf53cre_CR.integ.Stst.composition_intAnno2.barplot.pdf",
       width = 10.5, height = 3.5,
       plot = pcom1.intAnno2)
```


#### sig.test          

glm.nb - anova.LRT           



```{r message=FALSE, warning=FALSE}

Sort.N <- c("Stst.CTL","Stst.CKO")

glm.nb_anova.1.intAnno1 <- list()

for(x1 in 1:2){
  for(x2 in 1:2){
    if(x2>x1){
      
      stat1_intAnno1.s_N <- stat1_intAnno1.s %>% filter(cnt %in% c(Sort.N[x1],Sort.N[x2]))
      
      total.N <- stat1_intAnno1.s_N %>%
        group_by(cnt, rep) %>%
        summarise(total=sum(count)) %>% ungroup() %>% as.data.frame()
      
      rownames(total.N) <- paste0(as.character(total.N$cnt),
                                  "_",
                                  as.character(total.N$rep))
      
      stat1_intAnno1.s_N$total <- total.N[paste0(stat1_intAnno1.s_N$cnt,
                                            "_",
                                            stat1_intAnno1.s_N$rep),"total"]
      
      glm.nb_anova.1.intAnno1[[paste0(Sort.N[x1],"vs",Sort.N[x2])]] <- list()
      
      for(AA in levels(stat1_intAnno1.s_N$intAnno1)){
        glm.nb_anova.1.intAnno1[[paste0(Sort.N[x1],"vs",Sort.N[x2])]][[AA]] <- tryCatch({
          aaa <- stat1_intAnno1.s_N %>% filter(intAnno1==AA)
          aaa.glmnb <- MASS::glm.nb(count ~ cnt + offset(log(total)), data = aaa, maxit=1000)
          aaa.anova <- anova(aaa.glmnb, test = "LRT")
          aaa.anova$'Pr(>Chi)'[2]
        }, error=function(e){
        
          tryCatch({
            aaa <- stat1_intAnno1.s_N %>% filter(intAnno1==AA)
            aaa.glmnb <- MASS::glm.nb(count ~ cnt + offset(log(total)), data = aaa, maxit=100)
            aaa.anova <- anova(aaa.glmnb, test = "LRT")
            aaa.anova$'Pr(>Chi)'[2]
          }, error=function(e){
            
            tryCatch({
              aaa <- stat1_intAnno1.s_N %>% filter(intAnno1==AA)
              aaa.glmnb <- MASS::glm.nb(count ~ cnt + offset(log(total)), data = aaa, maxit=10)
              aaa.anova <- anova(aaa.glmnb, test = "LRT")
              aaa.anova$'Pr(>Chi)'[2]
            }, error = function(e){
              NA
            })     
          })
        })
      }
      glm.nb_anova.1.intAnno1[[paste0(Sort.N[x1],"vs",Sort.N[x2])]] <- unlist(glm.nb_anova.1.intAnno1[[paste0(Sort.N[x1],"vs",Sort.N[x2])]]) 
    }
  }
}


```


```{r}
glm.nb_anova.1.intAnno1_df <- t(data.frame(Reduce(function(x,y){rbind(x,y)},glm.nb_anova.1.intAnno1)))
rownames(glm.nb_anova.1.intAnno1_df) <- names(glm.nb_anova.1.intAnno1)
colnames(glm.nb_anova.1.intAnno1_df) <- gsub("X","C",colnames(glm.nb_anova.1.intAnno1_df))
glm.nb_anova.1.intAnno1_df
```


```{r eval=FALSE, include=FALSE}
write.csv(glm.nb_anova.1.intAnno1_df, "composition/Baf53cre_CR.integ.Stst.composition_intAnno1.glm.nb_anova.LRT.csv")
```


```{r}
#options (scipen = 999)
```


```{r}
round(glm.nb_anova.1.intAnno1_df,6)
```



```{r message=FALSE, warning=FALSE}

Sort.N <- c("Stst.CTL","Stst.CKO")

glm.nb_anova.1.intAnno2 <- list()

for(x1 in 1:2){
  for(x2 in 1:2){
    if(x2>x1){
      
      stat1_intAnno2.s_N <- stat1_intAnno2.s %>% filter(cnt %in% c(Sort.N[x1],Sort.N[x2]))
      
      total.N <- stat1_intAnno2.s_N %>%
        group_by(cnt, rep) %>%
        summarise(total=sum(count)) %>% ungroup() %>% as.data.frame()
      
      rownames(total.N) <- paste0(as.character(total.N$cnt),
                                  "_",
                                  as.character(total.N$rep))
      
      stat1_intAnno2.s_N$total <- total.N[paste0(stat1_intAnno2.s_N$cnt,
                                            "_",
                                            stat1_intAnno2.s_N$rep),"total"]
      
      glm.nb_anova.1.intAnno2[[paste0(Sort.N[x1],"vs",Sort.N[x2])]] <- list()
      
      for(AA in levels(stat1_intAnno2.s_N$intAnno2)){
        glm.nb_anova.1.intAnno2[[paste0(Sort.N[x1],"vs",Sort.N[x2])]][[AA]] <- tryCatch({
          aaa <- stat1_intAnno2.s_N %>% filter(intAnno2==AA)
          aaa.glmnb <- MASS::glm.nb(count ~ cnt + offset(log(total)), data = aaa, maxit=1000)
          aaa.anova <- anova(aaa.glmnb, test = "LRT")
          aaa.anova$'Pr(>Chi)'[2]
        }, error=function(e){
        
          tryCatch({
            aaa <- stat1_intAnno2.s_N %>% filter(intAnno2==AA)
            aaa.glmnb <- MASS::glm.nb(count ~ cnt + offset(log(total)), data = aaa, maxit=100)
            aaa.anova <- anova(aaa.glmnb, test = "LRT")
            aaa.anova$'Pr(>Chi)'[2]
          }, error=function(e){
            
            tryCatch({
              aaa <- stat1_intAnno2.s_N %>% filter(intAnno2==AA)
              aaa.glmnb <- MASS::glm.nb(count ~ cnt + offset(log(total)), data = aaa, maxit=10)
              aaa.anova <- anova(aaa.glmnb, test = "LRT")
              aaa.anova$'Pr(>Chi)'[2]
            }, error = function(e){
              NA
            })     
          })
        })
      }
      glm.nb_anova.1.intAnno2[[paste0(Sort.N[x1],"vs",Sort.N[x2])]] <- unlist(glm.nb_anova.1.intAnno2[[paste0(Sort.N[x1],"vs",Sort.N[x2])]]) 
    }
  }
}


```


```{r}
glm.nb_anova.1.intAnno2_df <- t(data.frame(Reduce(function(x,y){rbind(x,y)},glm.nb_anova.1.intAnno2)))
rownames(glm.nb_anova.1.intAnno2_df) <- names(glm.nb_anova.1.intAnno2)
colnames(glm.nb_anova.1.intAnno2_df) <- gsub("X","C",colnames(glm.nb_anova.1.intAnno2_df))
glm.nb_anova.1.intAnno2_df
```

```{r eval=FALSE, include=FALSE}
write.csv(glm.nb_anova.1.intAnno2_df, "composition/Baf53cre_CR.integ.Stst.composition_intAnno2.glm.nb_anova.LRT.csv")
```

```{r}
#options (scipen = 999)
```


```{r}
round(glm.nb_anova.1.intAnno2_df,5)
```


### CR7d        


#### heatmap        


```{r fig.width=6.4, fig.height=4.5}
cowplot::plot_grid(
pheatmap::pheatmap(table(cnt=test2.seur$sample,
      clusters=test2.seur$intAnno1)[c(4:7,1:3),],
                   main = "Cell Count",
                   gaps_row = c(4),
      gaps_col = c(5,9,12),
                   cluster_rows = F, cluster_cols = F, display_numbers = T, number_format = "%.0f", legend = F, silent = T)$gtable,

pheatmap::pheatmap(100*rowRatio(table(cnt=test2.seur$sample,
                                clusters=test2.seur$intAnno1)[c(4:7,1:3),] ),
                   main = "Cell Ratio",
                   gaps_row = c(4),
      gaps_col = c(5,9,12),
                   cluster_rows = F, cluster_cols = F, display_numbers = T, number_format = "%.1f", legend = F, silent =T)$gtable,
ncol = 1)
```

```{r fig.width=6.4, fig.height=4.5}
cowplot::plot_grid(
pheatmap::pheatmap(table(cnt=test2.seur$sample,
      clusters=test2.seur$intAnno2)[c(4:7,1:3),],
                   main = "Cell Count",
                   gaps_row = c(4),
      gaps_col = c(5,9,12),
                   cluster_rows = F, cluster_cols = F, display_numbers = T, number_format = "%.0f", legend = F, silent = T)$gtable,

pheatmap::pheatmap(100*rowRatio(table(cnt=test2.seur$sample,
                                clusters=test2.seur$intAnno2)[c(4:7,1:3),] ),
                   main = "Cell Ratio",
                   gaps_row = c(4),
      gaps_col = c(5,9,12),
                   cluster_rows = F, cluster_cols = F, display_numbers = T, number_format = "%.1f", legend = F, silent =T)$gtable,
ncol = 1)
```


#### barplot          


```{r}
stat2_intAnno1 <- test2.seur@meta.data[,c("cnt","rep","intAnno1")]

stat2_intAnno1.s <- stat2_intAnno1 %>%
  group_by(cnt,rep,intAnno1) %>%
  summarise(count=n()) %>%
  mutate(prop= count/sum(count)) %>%
  ungroup
```


```{r eval=FALSE, include=FALSE, paged.print=FALSE}
write.csv(stat2_intAnno1.s %>% reshape2::recast(cnt + rep ~ intAnno1, measure.var = 4), 
          "composition/Baf53cre_CR.integ.CR7d.composition_intAnno1.stat_df.count.csv")
write.csv(stat2_intAnno1.s %>% reshape2::recast(cnt + rep ~ intAnno1, measure.var = 5), 
          "composition/Baf53cre_CR.integ.CR7d.composition_intAnno1.stat_df.ratio.csv")
```


```{r  fig.height=3.5, fig.width=10.5}
pcom2.intAnno1 <- stat2_intAnno1.s %>%
  ggplot(aes(x = intAnno1, y = 100*prop, color=cnt)) +
  geom_bar(stat="summary", fun="mean", position = position_dodge(0.75), width = 0.58, fill="white") +
  theme_classic(base_size = 15) +
  scale_color_manual(values = color.test2, name="") +
  labs(title="Cell Composition of CR7d.CTL_CKO, intAnno1", y = "Proportion") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 9.6)) +
  
  geom_point(aes(x=intAnno1, y = 100*prop, color= cnt),
             position = position_dodge(0.75),
             shape=16,alpha=0.75,size=2.15,
             stroke=0.15, show.legend=F)

pcom2.intAnno1
```


```{r eval=FALSE, include=FALSE}
ggsave("./composition/Baf53cre_CR.integ.CR7d.composition_intAnno1.barplot.pdf",
       width = 10.5, height = 3.5,
       plot = pcom2.intAnno1)
```


```{r}
stat2_intAnno2 <- test2.seur@meta.data[,c("cnt","rep","intAnno2")]

stat2_intAnno2.s <- stat2_intAnno2 %>%
  group_by(cnt,rep,intAnno2) %>%
  summarise(count=n()) %>%
  mutate(prop= count/sum(count)) %>%
  ungroup
```


```{r eval=FALSE, include=FALSE, paged.print=FALSE}
write.csv(stat2_intAnno2.s %>% reshape2::recast(cnt + rep ~ intAnno2, measure.var = 4), 
          "composition/Baf53cre_CR.integ.CR7d.composition_intAnno2.stat_df.count.csv")
write.csv(stat2_intAnno2.s %>% reshape2::recast(cnt + rep ~ intAnno2, measure.var = 5), 
          "composition/Baf53cre_CR.integ.CR7d.composition_intAnno2.stat_df.ratio.csv")
```


```{r  fig.height=3.5, fig.width=10.5}
pcom2.intAnno2 <- stat2_intAnno2.s %>%
  ggplot(aes(x = intAnno2, y = 100*prop, color=cnt)) +
  geom_bar(stat="summary", fun="mean", position = position_dodge(0.75), width = 0.58, fill="white") +
  theme_classic(base_size = 15) +
  scale_color_manual(values = color.test2, name="") +
  labs(title="Cell Composition of CR7d.CTL_CKO, intAnno2", y = "Proportion") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 9.6)) +
  
  geom_point(aes(x=intAnno2, y = 100*prop, color= cnt),
             position = position_dodge(0.75),
             shape=16,alpha=0.75,size=2.15,
             stroke=0.15, show.legend=F)

pcom2.intAnno2
```


```{r eval=FALSE, include=FALSE}
ggsave("./composition/Baf53cre_CR.integ.CR7d.composition_intAnno2.barplot.pdf",
       width = 10.5, height = 3.5,
       plot = pcom2.intAnno2)
```


#### sig.test          

glm.nb - anova.LRT           



```{r message=FALSE, warning=FALSE}

Sort.N <- c("CR7d.CTL","CR7d.CKO")

glm.nb_anova.2.intAnno1 <- list()

for(x1 in 1:2){
  for(x2 in 1:2){
    if(x2>x1){
      
      stat2_intAnno1.s_N <- stat2_intAnno1.s %>% filter(cnt %in% c(Sort.N[x1],Sort.N[x2]))
      
      total.N <- stat2_intAnno1.s_N %>%
        group_by(cnt, rep) %>%
        summarise(total=sum(count)) %>% ungroup() %>% as.data.frame()
      
      rownames(total.N) <- paste0(as.character(total.N$cnt),
                                  "_",
                                  as.character(total.N$rep))
      
      stat2_intAnno1.s_N$total <- total.N[paste0(stat2_intAnno1.s_N$cnt,
                                            "_",
                                            stat2_intAnno1.s_N$rep),"total"]
      
      glm.nb_anova.2.intAnno1[[paste0(Sort.N[x1],"vs",Sort.N[x2])]] <- list()
      
      for(AA in levels(stat2_intAnno1.s_N$intAnno1)){
        glm.nb_anova.2.intAnno1[[paste0(Sort.N[x1],"vs",Sort.N[x2])]][[AA]] <- tryCatch({
          aaa <- stat2_intAnno1.s_N %>% filter(intAnno1==AA)
          aaa.glmnb <- MASS::glm.nb(count ~ cnt + offset(log(total)), data = aaa, maxit=1000)
          aaa.anova <- anova(aaa.glmnb, test = "LRT")
          aaa.anova$'Pr(>Chi)'[2]
        }, error=function(e){
        
          tryCatch({
            aaa <- stat2_intAnno1.s_N %>% filter(intAnno1==AA)
            aaa.glmnb <- MASS::glm.nb(count ~ cnt + offset(log(total)), data = aaa, maxit=100)
            aaa.anova <- anova(aaa.glmnb, test = "LRT")
            aaa.anova$'Pr(>Chi)'[2]
          }, error=function(e){
            
            tryCatch({
              aaa <- stat2_intAnno1.s_N %>% filter(intAnno1==AA)
              aaa.glmnb <- MASS::glm.nb(count ~ cnt + offset(log(total)), data = aaa, maxit=10)
              aaa.anova <- anova(aaa.glmnb, test = "LRT")
              aaa.anova$'Pr(>Chi)'[2]
            }, error = function(e){
              NA
            })     
          })
        })
      }
      glm.nb_anova.2.intAnno1[[paste0(Sort.N[x1],"vs",Sort.N[x2])]] <- unlist(glm.nb_anova.2.intAnno1[[paste0(Sort.N[x1],"vs",Sort.N[x2])]]) 
    }
  }
}


```


```{r}
glm.nb_anova.2.intAnno1_df <- t(data.frame(Reduce(function(x,y){rbind(x,y)},glm.nb_anova.2.intAnno1)))
rownames(glm.nb_anova.2.intAnno1_df) <- names(glm.nb_anova.2.intAnno1)
colnames(glm.nb_anova.2.intAnno1_df) <- gsub("X","C",colnames(glm.nb_anova.2.intAnno1_df))
glm.nb_anova.2.intAnno1_df
```

```{r eval=FALSE, include=FALSE}
write.csv(glm.nb_anova.2.intAnno1_df, "composition/Baf53cre_CR.integ.CR7d.composition_intAnno1.glm.nb_anova.LRT.csv")
```

```{r}
#options (scipen = 999)
```


```{r}
round(glm.nb_anova.2.intAnno1_df,4)
```



```{r message=FALSE, warning=FALSE}

Sort.N <- c("CR7d.CTL","CR7d.CKO")

glm.nb_anova.2.intAnno2 <- list()

for(x1 in 1:2){
  for(x2 in 1:2){
    if(x2>x1){
      
      stat2_intAnno2.s_N <- stat2_intAnno2.s %>% filter(cnt %in% c(Sort.N[x1],Sort.N[x2]))
      
      total.N <- stat2_intAnno2.s_N %>%
        group_by(cnt, rep) %>%
        summarise(total=sum(count)) %>% ungroup() %>% as.data.frame()
      
      rownames(total.N) <- paste0(as.character(total.N$cnt),
                                  "_",
                                  as.character(total.N$rep))
      
      stat2_intAnno2.s_N$total <- total.N[paste0(stat2_intAnno2.s_N$cnt,
                                            "_",
                                            stat2_intAnno2.s_N$rep),"total"]
      
      glm.nb_anova.2.intAnno2[[paste0(Sort.N[x1],"vs",Sort.N[x2])]] <- list()
      
      for(AA in levels(stat2_intAnno2.s_N$intAnno2)){
        glm.nb_anova.2.intAnno2[[paste0(Sort.N[x1],"vs",Sort.N[x2])]][[AA]] <- tryCatch({
          aaa <- stat2_intAnno2.s_N %>% filter(intAnno2==AA)
          aaa.glmnb <- MASS::glm.nb(count ~ cnt + offset(log(total)), data = aaa, maxit=1000)
          aaa.anova <- anova(aaa.glmnb, test = "LRT")
          aaa.anova$'Pr(>Chi)'[2]
        }, error=function(e){
        
          tryCatch({
            aaa <- stat2_intAnno2.s_N %>% filter(intAnno2==AA)
            aaa.glmnb <- MASS::glm.nb(count ~ cnt + offset(log(total)), data = aaa, maxit=100)
            aaa.anova <- anova(aaa.glmnb, test = "LRT")
            aaa.anova$'Pr(>Chi)'[2]
          }, error=function(e){
            
            tryCatch({
              aaa <- stat2_intAnno2.s_N %>% filter(intAnno2==AA)
              aaa.glmnb <- MASS::glm.nb(count ~ cnt + offset(log(total)), data = aaa, maxit=10)
              aaa.anova <- anova(aaa.glmnb, test = "LRT")
              aaa.anova$'Pr(>Chi)'[2]
            }, error = function(e){
              NA
            })     
          })
        })
      }
      glm.nb_anova.2.intAnno2[[paste0(Sort.N[x1],"vs",Sort.N[x2])]] <- unlist(glm.nb_anova.2.intAnno2[[paste0(Sort.N[x1],"vs",Sort.N[x2])]]) 
    }
  }
}


```


```{r}
glm.nb_anova.2.intAnno2_df <- t(data.frame(Reduce(function(x,y){rbind(x,y)},glm.nb_anova.2.intAnno2)))
rownames(glm.nb_anova.2.intAnno2_df) <- names(glm.nb_anova.2.intAnno2)
colnames(glm.nb_anova.2.intAnno2_df) <- gsub("X","C",colnames(glm.nb_anova.2.intAnno2_df))
glm.nb_anova.2.intAnno2_df
```

```{r eval=FALSE, include=FALSE}
write.csv(glm.nb_anova.2.intAnno2_df, "composition/Baf53cre_CR.integ.CR7d.composition_intAnno2.glm.nb_anova.LRT.csv")
```

```{r}
#options (scipen = 999)
```


```{r}
round(glm.nb_anova.2.intAnno2_df,4)
```


## all markers               


### intAnno1            


```{r message=FALSE, warning=FALSE, paged.print=TRUE}
# find markers for every cluster compared to all remaining cells
Idents(GEX.seur) <- "intAnno1"

GEX.seur <- PrepSCTFindMarkers(GEX.seur, assay = "SCT")
```


```{r eval=FALSE, include=FALSE}
#saveRDS(GEX.seur, "./sn10x_SZJ.sct_anno.s.rds")
#GEX.seur <- readRDS("./sn10x_SZJ.sct_anno.s.rds")
```


```{r message=FALSE, warning=FALSE, paged.print=TRUE}
#GEX.markers.pre <- FindAllMarkers(GEX.seur, only.pos = TRUE, min.pct = 0.01,
#                                  assay = "SCT",
#                                  test.use = "MAST",
#                                  logfc.threshold = 0.1)
GEX.markers.pre <- read.table("Baf53cre_CR.markers.SCT_intAnno1.202405.csv", header = TRUE, sep = ",")
#GEX.markers.pre %>% group_by(cluster) %>% top_n(n = 8, wt = avg_log2FC)
```


```{r eval=FALSE, include=FALSE}
write.table(GEX.markers.pre, 
            "Baf53cre_CR.markers.SCT_intAnno1.202405.csv", 
            col.names = TRUE,
            row.names = FALSE,
            quote = F,
            sep = ",")
```


```{r}
GEX.markers.pre$cluster <- factor(as.character(GEX.markers.pre$cluster),
                          levels = levels(GEX.seur$intAnno1))


markers.pre_t60 <- (GEX.markers.pre %>% group_by(cluster) %>% 
                  filter(pct.1>0.05 & gene %in% grep("Rps|Rpl|mt-|Hsp",gene,invert = T,value = T)) %>%
                   top_n(n = 60, wt = avg_log2FC) %>%
                   ungroup() %>%
  arrange(desc(avg_log2FC*pct.1),gene) %>%
                             distinct(gene, .keep_all = TRUE) %>%
                             arrange(cluster,p_val_adj))$gene

markers.pre_t120 <- (GEX.markers.pre %>% group_by(cluster) %>% 
                  filter(pct.1>0.05 & gene %in% grep("Rps|Rpl|mt-|Hsp",gene,invert = T,value = T)) %>%
                   top_n(n = 120, wt = avg_log2FC) %>%
                   ungroup() %>%
  arrange(desc(avg_log2FC*pct.1),gene) %>%
                             distinct(gene, .keep_all = TRUE) %>%
                             arrange(cluster,p_val_adj))$gene
```


```{r}
ttt = 468
ttt/60
ttt/64
ttt/65
```   

```{r fig.height=11.4, fig.width=7.6, message=FALSE, warning=FALSE}

pp.t60 <- list()

for(i in 1:8){
pp.t60[[i]] <- DotPlot(GEX.seur, features = rev(markers.pre_t60[(60*i-59):(60*i)]))  + coord_flip() + 
           theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 9.6))
}

pp.t60
``` 


```{r}
ttt = 839
ttt/60
ttt/64
ttt/65
```  


```{r fig.height=11.4, fig.width=7.6, message=FALSE, warning=FALSE}

pp.t120 <- list()

for(i in 1:14){
pp.t120[[i]] <- DotPlot(GEX.seur, features = rev(markers.pre_t120[(60*i-59):(60*i)]))  + coord_flip() + 
           theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 9.6))
}

pp.t120
``` 


## DEGs        


```{r paged.print=FALSE}
head(GEX.seur@meta.data)
```


```{r}
Idents(GEX.seur) <- "cnt"

#GEX.seur <- PrepSCTFindMarkers(GEX.seur, assay = "SCT")
```


```{r}
neur.clusters <- grep("EMN|IMN|IN|IPAN",levels(GEX.seur$intAnno2), value = T)
neur.clusters
```

```{r}
#
all_new <- neur.clusters
all_new
```

```{r}
#
list_new <- list()
list_new[["All"]] <- all_new

list_new[["EMNs"]] <- grep("EMN",all_new,value = T)
list_new[["IMNs"]] <- grep("IMN",all_new,value = T)

list_new[["IPAN1"]] <- grep("IPAN1",all_new,value = T)
list_new[["IPAN2"]] <- grep("IPAN2",all_new,value = T)

#list_new[["INs"]] <- grep("IN",all_new,value = T)
#list_new[["IPANs"]] <- grep("IPAN",all_new,value = T)

for(NN in all_new){
  list_new[[NN]] <- NN
}

names_new <- names(list_new)
list_new
```


```{r}
names_new
```


### Stst      


```{r}
#test1.seur <- subset(GEX.seur, subset= cnt %in% c("Stst.CTL","Stst.CKO"))
test1.seur
```


```{r}
#head(test1.seur@active.ident)
Idents(test1.seur) <- "cnt"
```


#### run              

```{r message=FALSE, warning=FALSE, include=FALSE}
test1.DEGs_new <- list()

for(nn in names_new){
  test1.DEGs_new[[nn]] <- FindAllMarkers(subset(test1.seur, subset = intAnno2 %in% list_new[[nn]]),
                                       assay = "RNA",
                                       only.pos = T,
                                       min.pct = 0.05,
                                       logfc.threshold = 0.1,
                                       test.use = "MAST")
}

```


```{r}
#test1.DEGs_new
```



```{r}
# save DEGs' table
df_test1.DEGs_new <- data.frame()
for(nn in names_new){

  df_test1.DEGs_new <- rbind(df_test1.DEGs_new, data.frame(test1.DEGs_new[[nn]],intAnno=nn))
  
  
}

#write.csv(df_test1.DEGs_new, "Baf53cre_CR.DEGs.Stst_CTLvsCKO.intAnno2.csv")
#write.csv(df_test1.DEGs_new %>% filter(intAnno %in% setdiff(names_new,paste0("IPAN",c(1.1,1.2,2.1,2.2)))), "Baf53cre_CR.DEGs.Stst_CTLvsCKO.intAnno1.csv")
```


#### stat            


cut0: padj 0.05  log2FC 0.1   
cut1: padj 0.05  log2FC 0.3         
cut2: padj 0.01  log2FC > log2(1.5) (|FC|>1.5)      


#### cut0           

```{r}
# cut1
cut.padj = 0.05
cut.log2FC = 0.1  
  
cut.pct1 = 0.1
```


```{r message=FALSE, warning=FALSE, paged.print=FALSE}
stat_test1o.DEGs_new <- df_test1.DEGs_new %>% filter(p_val_adj < cut.padj & 
                       abs(avg_log2FC) > cut.log2FC & 
                       pct.1 > cut.pct1) %>%
  group_by(intAnno,cluster) %>%
  summarise(up.DEGs = n()) %>% as.data.frame()
stat_test1o.DEGs_new
```


```{r message=FALSE, warning=FALSE, paged.print=FALSE, fig.width=9.5, fig.height=4}
df_test1.DEGs_new %>% filter(p_val_adj < cut.padj & 
                       abs(avg_log2FC) > cut.log2FC & 
                       pct.1 > cut.pct1) %>%
  group_by(intAnno,cluster) %>%
  summarise(up.DEGs = n()) %>% as.data.frame() %>%
  ggplot(aes(x=intAnno, y=up.DEGs, color = cluster)) +
  geom_bar(stat="summary", fun="mean", position = position_dodge(0.75), width = 0.58, fill="white") +
  geom_text(aes(label = up.DEGs),vjust=-0.21, show.legend = F, position = position_dodge(0.75) ) +
  theme_classic(base_size = 15) +
  scale_color_manual(values = color.test1, name="") +
  labs(title=paste0("up.DEGs stat, pct.1>",cut.pct1,", padj<",cut.padj,", |log2FC|>",cut.log2FC), y = "Count") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 9.6),
        title =element_text(size=12, face='bold'))
```




#### cut1           

```{r}
# cut1
cut.padj = 0.05
cut.log2FC = 0.3  
  
cut.pct1 = 0.1
```


```{r message=FALSE, warning=FALSE, paged.print=FALSE}
stat_test1a.DEGs_new <- df_test1.DEGs_new %>% filter(p_val_adj < cut.padj & 
                       abs(avg_log2FC) > cut.log2FC & 
                       pct.1 > cut.pct1) %>%
  group_by(intAnno,cluster) %>%
  summarise(up.DEGs = n()) %>% as.data.frame()
stat_test1a.DEGs_new
```


```{r message=FALSE, warning=FALSE, paged.print=FALSE, fig.width=9.5, fig.height=4}
df_test1.DEGs_new %>% filter(p_val_adj < cut.padj & 
                       abs(avg_log2FC) > cut.log2FC & 
                       pct.1 > cut.pct1) %>%
  group_by(intAnno,cluster) %>%
  summarise(up.DEGs = n()) %>% as.data.frame() %>%
  ggplot(aes(x=intAnno, y=up.DEGs, color = cluster)) +
  geom_bar(stat="summary", fun="mean", position = position_dodge(0.75), width = 0.58, fill="white") +
  geom_text(aes(label = up.DEGs),vjust=-0.21, show.legend = F, position = position_dodge(0.75) ) +
  theme_classic(base_size = 15) +
  scale_color_manual(values = color.test1, name="") +
  labs(title=paste0("up.DEGs stat, pct.1>",cut.pct1,", padj<",cut.padj,", |log2FC|>",cut.log2FC), y = "Count") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 9.6),
        title =element_text(size=12, face='bold'))
```


#### cut2            

```{r}
# cut2
cut.padj = 0.01
cut.log2FC = log2(1.5)  
  
cut.pct1 = 0.1
```


```{r message=FALSE, warning=FALSE, paged.print=FALSE}
stat_test1b.DEGs_new <- df_test1.DEGs_new %>% filter(p_val_adj < cut.padj & 
                       abs(avg_log2FC) > cut.log2FC & 
                       pct.1 > cut.pct1) %>%
  group_by(intAnno,cluster) %>%
  summarise(up.DEGs = n()) %>% as.data.frame()
stat_test1b.DEGs_new
```



```{r message=FALSE, warning=FALSE, paged.print=FALSE, fig.width=9.5, fig.height=4}
df_test1.DEGs_new %>% filter(p_val_adj < cut.padj & 
                       abs(avg_log2FC) > cut.log2FC & 
                       pct.1 > cut.pct1) %>%
  group_by(intAnno,cluster) %>%
  summarise(up.DEGs = n()) %>% as.data.frame() %>%
  ggplot(aes(x=intAnno, y=up.DEGs, color = cluster)) +
  geom_bar(stat="summary", fun="mean", position = position_dodge(0.75), width = 0.58, fill="white") +
  geom_text(aes(label = up.DEGs),vjust=-0.21, show.legend = F, position = position_dodge(0.75) ) +
  theme_classic(base_size = 15) +
  scale_color_manual(values = color.test1, name="") +
  labs(title=paste0("up.DEGs stat, pct.1>",cut.pct1,", padj<",cut.padj,", |FC|>",2^cut.log2FC), y = "Count") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 9.6),
        title =element_text(size=12, face='bold'))
```


```{r eval=FALSE, include=FALSE}
write.csv(stat_test1o.DEGs_new,"DEGs/stat_DEGs.Stst_CTLvsCKO.pct0.1_padj0.05_log2FC0.1.csv")
write.csv(stat_test1a.DEGs_new,"DEGs/stat_DEGs.Stst_CTLvsCKO.pct0.1_padj0.05_log2FC0.3.csv")
write.csv(stat_test1b.DEGs_new,"DEGs/stat_DEGs.Stst_CTLvsCKO.pct0.1_padj0.01_FC1.5.csv")
```



#### plot         

```{r}
pp_test1.DEGs.new <- lapply(list_new, function(x){NA})
```


```{r}
#
test1.DEGs_new.combine <- test1.DEGs_new
test1.DEGs_new.combine <- lapply(test1.DEGs_new.combine, function(x){
  x[x$cluster=="Stst.CTL","avg_log2FC"] <- -x[x$cluster=="Stst.CTL","avg_log2FC"]
  x
})

```


#### All           


```{r fig.width=15, fig.height=7.5}
pp_test1.DEGs.new$All <- test1.DEGs_new.combine$All %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"Stst.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"Stst.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("Stst.CTL"=as.vector(color.test1[1]),
                               "Stst.CKO"=as.vector(color.test1[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="All Stst.CTL vs Stst.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test1.DEGs.new$All
```


#### EMNs           


```{r fig.width=15, fig.height=7.5}
pp_test1.DEGs.new$EMNs <- test1.DEGs_new.combine$EMNs %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"Stst.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"Stst.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("Stst.CTL"=as.vector(color.test1[1]),
                               "Stst.CKO"=as.vector(color.test1[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="EMNs Stst.CTL vs Stst.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test1.DEGs.new$EMNs
```


#### EMN1           


```{r fig.width=15, fig.height=7.5}
pp_test1.DEGs.new$EMN1 <- test1.DEGs_new.combine$EMN1 %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"Stst.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"Stst.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("Stst.CTL"=as.vector(color.test1[1]),
                               "Stst.CKO"=as.vector(color.test1[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="EMN1 Stst.CTL vs Stst.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test1.DEGs.new$EMN1
```

#### EMN2           


```{r fig.width=15, fig.height=7.5}
pp_test1.DEGs.new$EMN2 <- test1.DEGs_new.combine$EMN2 %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"Stst.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"Stst.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("Stst.CTL"=as.vector(color.test1[1]),
                               "Stst.CKO"=as.vector(color.test1[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="EMN2 Stst.CTL vs Stst.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test1.DEGs.new$EMN2
```

#### EMN3           


```{r fig.width=15, fig.height=7.5}
pp_test1.DEGs.new$EMN3 <- test1.DEGs_new.combine$EMN3 %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"Stst.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"Stst.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("Stst.CTL"=as.vector(color.test1[1]),
                               "Stst.CKO"=as.vector(color.test1[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="EMN3 Stst.CTL vs Stst.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test1.DEGs.new$EMN3
```

#### EMN4           


```{r fig.width=15, fig.height=7.5}
pp_test1.DEGs.new$EMN4 <- test1.DEGs_new.combine$EMN4 %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"Stst.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"Stst.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("Stst.CTL"=as.vector(color.test1[1]),
                               "Stst.CKO"=as.vector(color.test1[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="EMN4 Stst.CTL vs Stst.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test1.DEGs.new$EMN4
```

#### EMN5           


```{r fig.width=15, fig.height=7.5}
pp_test1.DEGs.new$EMN5 <- test1.DEGs_new.combine$EMN5 %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"Stst.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"Stst.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("Stst.CTL"=as.vector(color.test1[1]),
                               "Stst.CKO"=as.vector(color.test1[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="EMN5 Stst.CTL vs Stst.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test1.DEGs.new$EMN5
```

#### IMNs           


```{r fig.width=15, fig.height=7.5}
pp_test1.DEGs.new$IMNs <- test1.DEGs_new.combine$IMNs %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"Stst.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"Stst.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("Stst.CTL"=as.vector(color.test1[1]),
                               "Stst.CKO"=as.vector(color.test1[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="IMNs Stst.CTL vs Stst.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test1.DEGs.new$IMNs
```

#### IMN1           


```{r fig.width=15, fig.height=7.5}
pp_test1.DEGs.new$IMN1 <- test1.DEGs_new.combine$IMN1 %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"Stst.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"Stst.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("Stst.CTL"=as.vector(color.test1[1]),
                               "Stst.CKO"=as.vector(color.test1[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="IMN1 Stst.CTL vs Stst.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test1.DEGs.new$IMN1
```


#### IMN2           


```{r fig.width=15, fig.height=7.5}
pp_test1.DEGs.new$IMN2 <- test1.DEGs_new.combine$IMN2 %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"Stst.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"Stst.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("Stst.CTL"=as.vector(color.test1[1]),
                               "Stst.CKO"=as.vector(color.test1[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="IMN2 Stst.CTL vs Stst.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test1.DEGs.new$IMN2
```


#### IMN3           


```{r fig.width=15, fig.height=7.5}
pp_test1.DEGs.new$IMN3 <- test1.DEGs_new.combine$IMN3 %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"Stst.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"Stst.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("Stst.CTL"=as.vector(color.test1[1]),
                               "Stst.CKO"=as.vector(color.test1[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="IMN3 Stst.CTL vs Stst.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test1.DEGs.new$IMN3
```


#### IMN4           


```{r fig.width=15, fig.height=7.5}
pp_test1.DEGs.new$IMN4 <- test1.DEGs_new.combine$IMN4 %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"Stst.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"Stst.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("Stst.CTL"=as.vector(color.test1[1]),
                               "Stst.CKO"=as.vector(color.test1[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="IMN4 Stst.CTL vs Stst.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test1.DEGs.new$IMN4
```

#### IN1           


```{r fig.width=15, fig.height=7.5}
pp_test1.DEGs.new$IN1 <- test1.DEGs_new.combine$IN1 %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"Stst.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"Stst.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("Stst.CTL"=as.vector(color.test1[1]),
                               "Stst.CKO"=as.vector(color.test1[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="IN1 Stst.CTL vs Stst.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test1.DEGs.new$IN1
```

#### IN2           


```{r fig.width=15, fig.height=7.5}
pp_test1.DEGs.new$IN2 <- test1.DEGs_new.combine$IN2 %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"Stst.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"Stst.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("Stst.CTL"=as.vector(color.test1[1]),
                               "Stst.CKO"=as.vector(color.test1[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="IN2 Stst.CTL vs Stst.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test1.DEGs.new$IN2
```

#### IN3           


```{r fig.width=15, fig.height=7.5}
pp_test1.DEGs.new$IN3 <- test1.DEGs_new.combine$IN3 %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"Stst.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"Stst.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("Stst.CTL"=as.vector(color.test1[1]),
                               "Stst.CKO"=as.vector(color.test1[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="IN3 Stst.CTL vs Stst.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test1.DEGs.new$IN3
```


#### IPAN1           


```{r fig.width=15, fig.height=7.5}
pp_test1.DEGs.new$IPAN1 <- test1.DEGs_new.combine$IPAN1 %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"Stst.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"Stst.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("Stst.CTL"=as.vector(color.test1[1]),
                               "Stst.CKO"=as.vector(color.test1[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="IPAN1 Stst.CTL vs Stst.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test1.DEGs.new$IPAN1
```


#### IPAN1.1           


```{r fig.width=15, fig.height=7.5}
pp_test1.DEGs.new$IPAN1.1 <- test1.DEGs_new.combine$IPAN1.1 %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"Stst.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"Stst.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("Stst.CTL"=as.vector(color.test1[1]),
                               "Stst.CKO"=as.vector(color.test1[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="IPAN1.1 Stst.CTL vs Stst.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test1.DEGs.new$IPAN1.1
```


#### IPAN1.2           


```{r fig.width=15, fig.height=7.5}
pp_test1.DEGs.new$IPAN1.2 <- test1.DEGs_new.combine$IPAN1.2 %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"Stst.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"Stst.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("Stst.CTL"=as.vector(color.test1[1]),
                               "Stst.CKO"=as.vector(color.test1[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="IPAN1.2 Stst.CTL vs Stst.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test1.DEGs.new$IPAN1.2
```

#### IPAN2           


```{r fig.width=15, fig.height=7.5}
pp_test1.DEGs.new$IPAN2 <- test1.DEGs_new.combine$IPAN2 %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"Stst.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"Stst.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("Stst.CTL"=as.vector(color.test1[1]),
                               "Stst.CKO"=as.vector(color.test1[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="IPAN2 Stst.CTL vs Stst.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test1.DEGs.new$IPAN2
```

#### IPAN2.1           


```{r fig.width=15, fig.height=7.5}
pp_test1.DEGs.new$IPAN2.1 <- test1.DEGs_new.combine$IPAN2.1 %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"Stst.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"Stst.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("Stst.CTL"=as.vector(color.test1[1]),
                               "Stst.CKO"=as.vector(color.test1[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="IPAN2.1 Stst.CTL vs Stst.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test1.DEGs.new$IPAN2.1
```

#### IPAN2.2           


```{r fig.width=15, fig.height=7.5}
pp_test1.DEGs.new$IPAN2.2 <- test1.DEGs_new.combine$IPAN2.2 %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"Stst.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"Stst.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("Stst.CTL"=as.vector(color.test1[1]),
                               "Stst.CKO"=as.vector(color.test1[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="IPAN2.2 Stst.CTL vs Stst.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test1.DEGs.new$IPAN2.2
```


#### IPAN3           


```{r fig.width=15, fig.height=7.5}
pp_test1.DEGs.new$IPAN3 <- test1.DEGs_new.combine$IPAN3 %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"Stst.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"Stst.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("Stst.CTL"=as.vector(color.test1[1]),
                               "Stst.CKO"=as.vector(color.test1[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="IPAN3 Stst.CTL vs Stst.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test1.DEGs.new$IPAN3
```


#### IPAN4           


```{r fig.width=15, fig.height=7.5}
pp_test1.DEGs.new$IPAN4 <- test1.DEGs_new.combine$IPAN4 %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"Stst.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"Stst.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("Stst.CTL"=as.vector(color.test1[1]),
                               "Stst.CKO"=as.vector(color.test1[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="IPAN4 Stst.CTL vs Stst.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test1.DEGs.new$IPAN4
```


```{r eval=FALSE, include=FALSE}
for(XX in names(pp_test1.DEGs.new)){
  
  ggsave(paste0("./DEGs/Stst/volcano.Stst_CTLvsCKO.",XX,".pdf"),
         width = 15,height = 7.5,
         plot = pp_test1.DEGs.new[[XX]])
  
}
```



### CR7d      


```{r}
#test2.seur <- subset(GEX.seur, subset= cnt %in% c("CR7d.CTL","CR7d.CKO"))
test2.seur
```


```{r}
#head(test2.seur@active.ident)
Idents(test2.seur) <- "cnt"
```


#### run              

```{r message=FALSE, warning=FALSE, include=FALSE}
test2.DEGs_new <- list()

for(nn in names_new){
  test2.DEGs_new[[nn]] <- FindAllMarkers(subset(test2.seur, subset = intAnno2 %in% list_new[[nn]]),
                                       assay = "RNA",
                                       only.pos = T,
                                       min.pct = 0.05,
                                       logfc.threshold = 0.1,
                                       test.use = "MAST")
}

```


```{r}
#test2.DEGs_new
```



```{r}
# save DEGs' table
df_test2.DEGs_new <- data.frame()
for(nn in names_new){
  df_test2.DEGs_new <- rbind(df_test2.DEGs_new, data.frame(test2.DEGs_new[[nn]],intAnno=nn))
}

#write.csv(df_test2.DEGs_new, "Baf53cre_CR.DEGs.CR7d_CTLvsCKO.intAnno2.csv")
#write.csv(df_test2.DEGs_new %>% filter(intAnno %in% setdiff(names_new,paste0("IPAN",c(1.1,1.2,2.1,2.2)))), "Baf53cre_CR.DEGs.CR7d_CTLvsCKO.intAnno1.csv")
```


#### stat            


cut0: padj 0.05  log2FC 0.1   
cut1: padj 0.05  log2FC 0.3         
cut2: padj 0.01  log2FC > log2(1.5) (|FC|>1.5)      


#### cut0           

```{r}
# cut1
cut.padj = 0.05
cut.log2FC = 0.1  
  
cut.pct1 = 0.1
```


```{r message=FALSE, warning=FALSE, paged.print=FALSE}
stat_test2o.DEGs_new <- df_test2.DEGs_new %>% filter(p_val_adj < cut.padj & 
                       abs(avg_log2FC) > cut.log2FC & 
                       pct.1 > cut.pct1) %>%
  group_by(intAnno,cluster) %>%
  summarise(up.DEGs = n()) %>% as.data.frame()
stat_test2o.DEGs_new
```


```{r message=FALSE, warning=FALSE, paged.print=FALSE, fig.width=9.5, fig.height=4}
df_test2.DEGs_new %>% filter(p_val_adj < cut.padj & 
                       abs(avg_log2FC) > cut.log2FC & 
                       pct.1 > cut.pct1) %>%
  group_by(intAnno,cluster) %>%
  summarise(up.DEGs = n()) %>% as.data.frame() %>%
  ggplot(aes(x=intAnno, y=up.DEGs, color = cluster)) +
  geom_bar(stat="summary", fun="mean", position = position_dodge(0.75), width = 0.58, fill="white") +
  geom_text(aes(label = up.DEGs),vjust=-0.21, show.legend = F, position = position_dodge(0.75) ) +
  theme_classic(base_size = 15) +
  scale_color_manual(values = color.test2, name="") +
  labs(title=paste0("up.DEGs stat, pct.1>",cut.pct1,", padj<",cut.padj,", |log2FC|>",cut.log2FC), y = "Count") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 9.6),
        title =element_text(size=12, face='bold'))
```




#### cut1           

```{r}
# cut1
cut.padj = 0.05
cut.log2FC = 0.3  
  
cut.pct1 = 0.1
```


```{r message=FALSE, warning=FALSE, paged.print=FALSE}
stat_test2a.DEGs_new <- df_test2.DEGs_new %>% filter(p_val_adj < cut.padj & 
                       abs(avg_log2FC) > cut.log2FC & 
                       pct.1 > cut.pct1) %>%
  group_by(intAnno,cluster) %>%
  summarise(up.DEGs = n()) %>% as.data.frame()
stat_test2a.DEGs_new
```


```{r message=FALSE, warning=FALSE, paged.print=FALSE, fig.width=9.5, fig.height=4}
df_test2.DEGs_new %>% filter(p_val_adj < cut.padj & 
                       abs(avg_log2FC) > cut.log2FC & 
                       pct.1 > cut.pct1) %>%
  group_by(intAnno,cluster) %>%
  summarise(up.DEGs = n()) %>% as.data.frame() %>%
  ggplot(aes(x=intAnno, y=up.DEGs, color = cluster)) +
  geom_bar(stat="summary", fun="mean", position = position_dodge(0.75), width = 0.58, fill="white") +
  geom_text(aes(label = up.DEGs),vjust=-0.21, show.legend = F, position = position_dodge(0.75) ) +
  theme_classic(base_size = 15) +
  scale_color_manual(values = color.test2, name="") +
  labs(title=paste0("up.DEGs stat, pct.1>",cut.pct1,", padj<",cut.padj,", |log2FC|>",cut.log2FC), y = "Count") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 9.6),
        title =element_text(size=12, face='bold'))
```


#### cut2            

```{r}
# cut2
cut.padj = 0.01
cut.log2FC = log2(1.5)  
  
cut.pct1 = 0.1
```


```{r message=FALSE, warning=FALSE, paged.print=FALSE}
stat_test2b.DEGs_new <- df_test2.DEGs_new %>% filter(p_val_adj < cut.padj & 
                       abs(avg_log2FC) > cut.log2FC & 
                       pct.1 > cut.pct1) %>%
  group_by(intAnno,cluster) %>%
  summarise(up.DEGs = n()) %>% as.data.frame()
stat_test2b.DEGs_new
```



```{r message=FALSE, warning=FALSE, paged.print=FALSE, fig.width=9.5, fig.height=4}
df_test2.DEGs_new %>% filter(p_val_adj < cut.padj & 
                       abs(avg_log2FC) > cut.log2FC & 
                       pct.1 > cut.pct1) %>%
  group_by(intAnno,cluster) %>%
  summarise(up.DEGs = n()) %>% as.data.frame() %>%
  ggplot(aes(x=intAnno, y=up.DEGs, color = cluster)) +
  geom_bar(stat="summary", fun="mean", position = position_dodge(0.75), width = 0.58, fill="white") +
  geom_text(aes(label = up.DEGs),vjust=-0.21, show.legend = F, position = position_dodge(0.75) ) +
  theme_classic(base_size = 15) +
  scale_color_manual(values = color.test2, name="") +
  labs(title=paste0("up.DEGs stat, pct.1>",cut.pct1,", padj<",cut.padj,", |FC|>",2^cut.log2FC), y = "Count") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 9.6),
        title =element_text(size=12, face='bold'))
```


```{r eval=FALSE, include=FALSE}
write.csv(stat_test2o.DEGs_new,"DEGs/stat_DEGs.CR7d_CTLvsCKO.pct0.1_padj0.05_log2FC0.1.csv")
write.csv(stat_test2a.DEGs_new,"DEGs/stat_DEGs.CR7d_CTLvsCKO.pct0.1_padj0.05_log2FC0.3.csv")
write.csv(stat_test2b.DEGs_new,"DEGs/stat_DEGs.CR7d_CTLvsCKO.pct0.1_padj0.01_FC1.5.csv")
```


#### plot         


```{r}
pp_test2.DEGs.new <- lapply(list_new, function(x){NA})
```


```{r}
#
test2.DEGs_new.combine <- test2.DEGs_new
test2.DEGs_new.combine <- lapply(test2.DEGs_new.combine, function(x){
  x[x$cluster=="CR7d.CTL","avg_log2FC"] <- -x[x$cluster=="CR7d.CTL","avg_log2FC"]
  x
})

```


#### All           


```{r fig.width=15, fig.height=7.5}
pp_test2.DEGs.new$All <- test2.DEGs_new.combine$All %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"CR7d.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"CR7d.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("CR7d.CTL"=as.vector(color.test2[1]),
                               "CR7d.CKO"=as.vector(color.test2[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="All CR7d.CTL vs CR7d.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test2.DEGs.new$All
```


#### EMNs           


```{r fig.width=15, fig.height=7.5}
pp_test2.DEGs.new$EMNs <- test2.DEGs_new.combine$EMNs %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"CR7d.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"CR7d.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("CR7d.CTL"=as.vector(color.test2[1]),
                               "CR7d.CKO"=as.vector(color.test2[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="EMNs CR7d.CTL vs CR7d.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test2.DEGs.new$EMNs
```


#### EMN1           


```{r fig.width=15, fig.height=7.5}
pp_test2.DEGs.new$EMN1 <- test2.DEGs_new.combine$EMN1 %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"CR7d.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"CR7d.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("CR7d.CTL"=as.vector(color.test2[1]),
                               "CR7d.CKO"=as.vector(color.test2[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="EMN1 CR7d.CTL vs CR7d.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test2.DEGs.new$EMN1
```

#### EMN2           


```{r fig.width=15, fig.height=7.5}
pp_test2.DEGs.new$EMN2 <- test2.DEGs_new.combine$EMN2 %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"CR7d.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"CR7d.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("CR7d.CTL"=as.vector(color.test2[1]),
                               "CR7d.CKO"=as.vector(color.test2[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="EMN2 CR7d.CTL vs CR7d.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test2.DEGs.new$EMN2
```

#### EMN3           


```{r fig.width=15, fig.height=7.5}
pp_test2.DEGs.new$EMN3 <- test2.DEGs_new.combine$EMN3 %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"CR7d.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"CR7d.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("CR7d.CTL"=as.vector(color.test2[1]),
                               "CR7d.CKO"=as.vector(color.test2[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="EMN3 CR7d.CTL vs CR7d.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test2.DEGs.new$EMN3
```

#### EMN4           


```{r fig.width=15, fig.height=7.5}
pp_test2.DEGs.new$EMN4 <- test2.DEGs_new.combine$EMN4 %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"CR7d.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"CR7d.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("CR7d.CTL"=as.vector(color.test2[1]),
                               "CR7d.CKO"=as.vector(color.test2[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="EMN4 CR7d.CTL vs CR7d.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test2.DEGs.new$EMN4
```

#### EMN5           


```{r fig.width=15, fig.height=7.5}
pp_test2.DEGs.new$EMN5 <- test2.DEGs_new.combine$EMN5 %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"CR7d.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"CR7d.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("CR7d.CTL"=as.vector(color.test2[1]),
                               "CR7d.CKO"=as.vector(color.test2[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="EMN5 CR7d.CTL vs CR7d.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test2.DEGs.new$EMN5
```

#### IMNs           


```{r fig.width=15, fig.height=7.5}
pp_test2.DEGs.new$IMNs <- test2.DEGs_new.combine$IMNs %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"CR7d.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"CR7d.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("CR7d.CTL"=as.vector(color.test2[1]),
                               "CR7d.CKO"=as.vector(color.test2[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="IMNs CR7d.CTL vs CR7d.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test2.DEGs.new$IMNs
```

#### IMN1           


```{r fig.width=15, fig.height=7.5}
pp_test2.DEGs.new$IMN1 <- test2.DEGs_new.combine$IMN1 %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"CR7d.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"CR7d.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("CR7d.CTL"=as.vector(color.test2[1]),
                               "CR7d.CKO"=as.vector(color.test2[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="IMN1 CR7d.CTL vs CR7d.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test2.DEGs.new$IMN1
```


#### IMN2           


```{r fig.width=15, fig.height=7.5}
pp_test2.DEGs.new$IMN2 <- test2.DEGs_new.combine$IMN2 %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"CR7d.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"CR7d.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("CR7d.CTL"=as.vector(color.test2[1]),
                               "CR7d.CKO"=as.vector(color.test2[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="IMN2 CR7d.CTL vs CR7d.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test2.DEGs.new$IMN2
```


#### IMN3           


```{r fig.width=15, fig.height=7.5}
pp_test2.DEGs.new$IMN3 <- test2.DEGs_new.combine$IMN3 %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"CR7d.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"CR7d.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("CR7d.CTL"=as.vector(color.test2[1]),
                               "CR7d.CKO"=as.vector(color.test2[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="IMN3 CR7d.CTL vs CR7d.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test2.DEGs.new$IMN3
```


#### IMN4           


```{r fig.width=15, fig.height=7.5}
pp_test2.DEGs.new$IMN4 <- test2.DEGs_new.combine$IMN4 %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"CR7d.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"CR7d.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("CR7d.CTL"=as.vector(color.test2[1]),
                               "CR7d.CKO"=as.vector(color.test2[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="IMN4 CR7d.CTL vs CR7d.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test2.DEGs.new$IMN4
```

#### IN1           


```{r fig.width=15, fig.height=7.5}
pp_test2.DEGs.new$IN1 <- test2.DEGs_new.combine$IN1 %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"CR7d.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"CR7d.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("CR7d.CTL"=as.vector(color.test2[1]),
                               "CR7d.CKO"=as.vector(color.test2[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="IN1 CR7d.CTL vs CR7d.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test2.DEGs.new$IN1
```

#### IN2           


```{r fig.width=15, fig.height=7.5}
pp_test2.DEGs.new$IN2 <- test2.DEGs_new.combine$IN2 %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"CR7d.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"CR7d.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("CR7d.CTL"=as.vector(color.test2[1]),
                               "CR7d.CKO"=as.vector(color.test2[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="IN2 CR7d.CTL vs CR7d.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test2.DEGs.new$IN2
```

#### IN3           


```{r fig.width=15, fig.height=7.5}
pp_test2.DEGs.new$IN3 <- test2.DEGs_new.combine$IN3 %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"CR7d.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"CR7d.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("CR7d.CTL"=as.vector(color.test2[1]),
                               "CR7d.CKO"=as.vector(color.test2[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="IN3 CR7d.CTL vs CR7d.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test2.DEGs.new$IN3
```


#### IPAN1           


```{r fig.width=15, fig.height=7.5}
pp_test2.DEGs.new$IPAN1 <- test2.DEGs_new.combine$IPAN1 %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"CR7d.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"CR7d.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("CR7d.CTL"=as.vector(color.test2[1]),
                               "CR7d.CKO"=as.vector(color.test2[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="IPAN1 CR7d.CTL vs CR7d.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test2.DEGs.new$IPAN1
```


#### IPAN1.1           


```{r fig.width=15, fig.height=7.5}
pp_test2.DEGs.new$IPAN1.1 <- test2.DEGs_new.combine$IPAN1.1 %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"CR7d.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"CR7d.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("CR7d.CTL"=as.vector(color.test2[1]),
                               "CR7d.CKO"=as.vector(color.test2[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="IPAN1.1 CR7d.CTL vs CR7d.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test2.DEGs.new$IPAN1.1
```


#### IPAN1.2           


```{r fig.width=15, fig.height=7.5}
pp_test2.DEGs.new$IPAN1.2 <- test2.DEGs_new.combine$IPAN1.2 %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"CR7d.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"CR7d.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("CR7d.CTL"=as.vector(color.test2[1]),
                               "CR7d.CKO"=as.vector(color.test2[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="IPAN1.2 CR7d.CTL vs CR7d.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test2.DEGs.new$IPAN1.2
```

#### IPAN2           


```{r fig.width=15, fig.height=7.5}
pp_test2.DEGs.new$IPAN2 <- test2.DEGs_new.combine$IPAN2 %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"CR7d.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"CR7d.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("CR7d.CTL"=as.vector(color.test2[1]),
                               "CR7d.CKO"=as.vector(color.test2[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="IPAN2 CR7d.CTL vs CR7d.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test2.DEGs.new$IPAN2
```

#### IPAN2.1           


```{r fig.width=15, fig.height=7.5}
pp_test2.DEGs.new$IPAN2.1 <- test2.DEGs_new.combine$IPAN2.1 %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"CR7d.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"CR7d.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("CR7d.CTL"=as.vector(color.test2[1]),
                               "CR7d.CKO"=as.vector(color.test2[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="IPAN2.1 CR7d.CTL vs CR7d.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test2.DEGs.new$IPAN2.1
```

#### IPAN2.2           


```{r fig.width=15, fig.height=7.5}
pp_test2.DEGs.new$IPAN2.2 <- test2.DEGs_new.combine$IPAN2.2 %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"CR7d.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"CR7d.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("CR7d.CTL"=as.vector(color.test2[1]),
                               "CR7d.CKO"=as.vector(color.test2[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="IPAN2.2 CR7d.CTL vs CR7d.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test2.DEGs.new$IPAN2.2
```


#### IPAN3           


```{r fig.width=15, fig.height=7.5}
pp_test2.DEGs.new$IPAN3 <- test2.DEGs_new.combine$IPAN3 %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"CR7d.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"CR7d.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("CR7d.CTL"=as.vector(color.test2[1]),
                               "CR7d.CKO"=as.vector(color.test2[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="IPAN3 CR7d.CTL vs CR7d.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test2.DEGs.new$IPAN3
```


#### IPAN4           


```{r fig.width=15, fig.height=7.5}
pp_test2.DEGs.new$IPAN4 <- test2.DEGs_new.combine$IPAN4 %>%
  mutate(label=ifelse(((p_val_adj < 1e-3 & avg_log2FC<0) | (p_val_adj < 1e-3 & avg_log2FC>0) | (p_val_adj < 0.05 & abs(avg_log2FC) > 0.1)) &
                        #!grepl("^Gm|^Hsp|^Rps|^Rpl|Rik$|Xist|Tsix|Uty|Ddx3y|Eif2s3y|Kdm5d",gene),gene,""),
                        !grepl("^Rps|^Rpl",gene),gene,""),
         sig.=ifelse(p_val_adj<0.05 & avg_log2FC<0,"CR7d.CTL",ifelse(p_val_adj<0.05 & avg_log2FC>0,"CR7d.CKO","None")),
         padj=ifelse(p_val_adj<1e-60,p_val_adj+1e-60,p_val_adj)) %>%
  ggplot(aes(y= -log10(padj), x=avg_log2FC, size=pct.1, label=label,fill=sig.)) +
  geom_point(shape=21, alpha=0.65) +
  geom_text_repel(size=2.5, max.overlaps = 500) +
  scale_fill_manual(values = c("CR7d.CTL"=as.vector(color.test2[1]),
                               "CR7d.CKO"=as.vector(color.test2[2]),
                               "None"="grey")) +
  theme_classic() + labs(title="IPAN4 CR7d.CTL vs CR7d.CKO") +
  guides(size = guide_legend(order = 2), fill=guide_legend(order = 1, reverse = F)) +
  geom_vline(xintercept = c(-0.1,0.1), linetype="dotted")
pp_test2.DEGs.new$IPAN4
```


```{r eval=FALSE, include=FALSE}
for(XX in names(pp_test2.DEGs.new)){
  
  ggsave(paste0("./DEGs/CR7d/volcano.CR7d_CTLvsCKO.",XX,".pdf"),
         width = 15,height = 7.5,
         plot = pp_test2.DEGs.new[[XX]])
  
}
```



## final markers        


### short_old           


```{r}
markers.old.s <- list(EMN=c("Chat","Bnc2",#"Tox","Ptprt",
                       "Gfra2","Oprk1",#"Adamtsl1", 
                       "Fbxw15","Fbxw24",#"Chrna7",
                       "Satb1","Cntnap5b",
                       "Gabrb1","Nxph1","Lama2","Lrrc7",
                       "Ryr3",#"Eda",
                       "Tac1",
                       #"Kctd8","Ntrk2",
                       "Penk", 
                       "Fut9","Nfatc1","Egfr","Ahr"#,#"Mgll",
                       #"Chrm3"
                       ),
                 IMN=c("Nos1","Kcnab1",
                       "Gfra1","Etv1",
                       #"Man1a","Airn",
                       "Adcy2","Cmah","Creb5","Vip","Pde1a",
                       "Ebf1"#,"Gpc5"
                       ),
                 IN=c("Npas3","Synpr","St18","Gal",
                      "Neurod6",
                      #"Kcnk13",
                      "Moxd1","Sctr",
                      "Piezo1","Sst",#"Adamts9",
                      "Kcnn2"),
                 IPAN=c("Calb2","Calcb","Nmu","Adgrg6",#"Pcdh10",
                        "Ngfr","Galr1","Il7",#"Aff2",
                        #"Gpr149",
                        "Cdh6","Cdh8",
                        "Clstn2",#"Ano2","Ntrk3",
                        "Cpne4",#"Vwc2l",
                        "Cdh9","Scgn",
                        #"Vcan",
                        "Cck","Piezo2","Kcnh7",
                        #"Rerg",
                        "Bmpr1b","Skap1","Ntng1",
                        "Tafa2","Nxph2"))
```


```{r eval=FALSE, include=FALSE}
sink("./figures.integration/dotplot.old/final_markers.old_addAhr.dotplot_short.csv")

markers.old.s

sink()
```


```{r fig.height=4.75, fig.width=11.5, message=FALSE, warning=FALSE}
pn.intAnno1.test0a <- DotPlot(GEX.seur, features = as.vector(unlist(markers.old.s)), group.by = "intAnno1",
        cols = c("midnightblue","darkorange1")) +
  #coord_flip() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1,size = 9.15))+ 
  scale_color_gradientn(colours  = material.heat(100)) +
  #scale_x_discrete(limits=rev) + 
  scale_y_discrete(limits=rev) + 
  labs(title="All intAnno1")
pn.intAnno1.test0a
```

```{r fig.height=5, fig.width=11.5, message=FALSE, warning=FALSE}
pn.intAnno2.test0a <- DotPlot(GEX.seur, features = as.vector(unlist(markers.old.s)), group.by = "intAnno2",
        cols = c("midnightblue","darkorange1")) +
  #coord_flip() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1,size = 9.15))+ 
  scale_color_gradientn(colours  = material.heat(100)) +
  #scale_x_discrete(limits=rev) + 
  scale_y_discrete(limits=rev) + 
  labs(title="All intAnno2")
pn.intAnno2.test0a
```

```{r fig.height=10, fig.width=5.5, message=FALSE, warning=FALSE}
pn.intAnno1.test0b <- DotPlot(GEX.seur, features = as.vector(unlist(markers.old.s)), group.by = "intAnno1",
        cols = c("midnightblue","darkorange1")) +
  coord_flip() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4,size = 9.15))+ 
  scale_color_gradientn(colours  = material.heat(100)) +
  #scale_x_discrete(limits=rev) + scale_y_discrete(limits=rev) + 
  labs(title="All intAnno1")
pn.intAnno1.test0b
```


```{r fig.height=10, fig.width=6, message=FALSE, warning=FALSE}
pn.intAnno2.test0b <- DotPlot(GEX.seur, features = as.vector(unlist(markers.old.s)), group.by = "intAnno2",
        cols = c("midnightblue","darkorange1")) +
  coord_flip() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4,size = 9.15))+ 
  scale_color_gradientn(colours  = material.heat(100)) +
  #scale_x_discrete(limits=rev) + scale_y_discrete(limits=rev) + 
  labs(title="All intAnno2")
pn.intAnno2.test0b
```


```{r eval=FALSE, include=FALSE}
#
ggsave("figures.integration/dotplot.old/dotplot.old_addAhr.All_intAnno1.a.pdf",
       width = 12.75,height = 5,
       plot = pn.intAnno1.test0a)
ggsave("figures.integration/dotplot.old/dotplot.old_addAhr.All_intAnno2.a.pdf",
       width = 12.75,height = 5.4,
       plot = pn.intAnno2.test0a)

#
ggsave("figures.integration/dotplot.old/dotplot.old_addAhr.All_intAnno1.b.pdf",
       width = 6.5,height = 12,
       plot = pn.intAnno1.test0b)
ggsave("figures.integration/dotplot.old/dotplot.old_addAhr.All_intAnno2.b.pdf",
       width = 7,height = 12,
       plot = pn.intAnno2.test0b)

```


```{r fig.height=4.75, fig.width=11.5, message=FALSE, warning=FALSE}
pn.intAnno1.test1a <- DotPlot(test1.seur, features = as.vector(unlist(markers.old.s)), group.by = "intAnno1",
        cols = c("midnightblue","darkorange1")) +
  #coord_flip() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1,size = 9.15))+ 
  scale_color_gradientn(colours  = material.heat(100)) +
  #scale_x_discrete(limits=rev) + 
  scale_y_discrete(limits=rev) + 
  labs(title="Stst intAnno1")
pn.intAnno1.test1a
```

```{r fig.height=5, fig.width=11.5, message=FALSE, warning=FALSE}
pn.intAnno2.test1a <- DotPlot(test1.seur, features = as.vector(unlist(markers.old.s)), group.by = "intAnno2",
        cols = c("midnightblue","darkorange1")) +
  #coord_flip() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1,size = 9.15))+ 
  scale_color_gradientn(colours  = material.heat(100)) +
  #scale_x_discrete(limits=rev) + 
  scale_y_discrete(limits=rev) + 
  labs(title="Stst intAnno2")
pn.intAnno2.test1a
```

```{r fig.height=10, fig.width=5.5, message=FALSE, warning=FALSE}
pn.intAnno1.test1b <- DotPlot(test1.seur, features = as.vector(unlist(markers.old.s)), group.by = "intAnno1",
        cols = c("midnightblue","darkorange1")) +
  coord_flip() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4,size = 9.15))+ 
  scale_color_gradientn(colours  = material.heat(100)) +
  #scale_x_discrete(limits=rev) + scale_y_discrete(limits=rev) + 
  labs(title="Stst intAnno1")
pn.intAnno1.test1b
```


```{r fig.height=10, fig.width=6, message=FALSE, warning=FALSE}
pn.intAnno2.test1b <- DotPlot(test1.seur, features = as.vector(unlist(markers.old.s)), group.by = "intAnno2",
        cols = c("midnightblue","darkorange1")) +
  coord_flip() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4,size = 9.15))+ 
  scale_color_gradientn(colours  = material.heat(100)) +
  #scale_x_discrete(limits=rev) + scale_y_discrete(limits=rev) + 
  labs(title="Stst intAnno2")
pn.intAnno2.test1b
```


```{r eval=FALSE, include=FALSE}
#
ggsave("figures.integration/dotplot.old/dotplot.old_addAhr.Stst_intAnno1.a.pdf",
       width = 12.75,height = 5,
       plot = pn.intAnno1.test1a)
ggsave("figures.integration/dotplot.old/dotplot.old_addAhr.StstF_intAnno2.a.pdf",
       width = 12.75,height = 5.4,
       plot = pn.intAnno2.test1a)

#
ggsave("figures.integration/dotplot.old/dotplot.old_addAhr.Stst_intAnno1.b.pdf",
       width = 6.5,height = 12,
       plot = pn.intAnno1.test1b)
ggsave("figures.integration/dotplot.old/dotplot.old_addAhr.Stst_intAnno2.b.pdf",
       width = 7,height = 12,
       plot = pn.intAnno2.test1b)

```


```{r fig.height=4.75, fig.width=11.5, message=FALSE, warning=FALSE}
pn.intAnno1.test2a <- DotPlot(test2.seur, features = as.vector(unlist(markers.old.s)), group.by = "intAnno1",
        cols = c("midnightblue","darkorange1")) +
  #coord_flip() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1,size = 9.15))+ 
  scale_color_gradientn(colours  = material.heat(100)) +
  #scale_x_discrete(limits=rev) + 
  scale_y_discrete(limits=rev) + 
  labs(title="CR7d intAnno1")
pn.intAnno1.test2a
```

```{r fig.height=5, fig.width=11.5, message=FALSE, warning=FALSE}
pn.intAnno2.test2a <- DotPlot(test2.seur, features = as.vector(unlist(markers.old.s)), group.by = "intAnno2",
        cols = c("midnightblue","darkorange1")) +
  #coord_flip() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1,size = 9.15))+ 
  scale_color_gradientn(colours  = material.heat(100)) +
  #scale_x_discrete(limits=rev) + 
  scale_y_discrete(limits=rev) + 
  labs(title="CR7d intAnno2")
pn.intAnno2.test2a
```

```{r fig.height=10, fig.width=5.5, message=FALSE, warning=FALSE}
pn.intAnno1.test2b <- DotPlot(test2.seur, features = as.vector(unlist(markers.old.s)), group.by = "intAnno1",
        cols = c("midnightblue","darkorange1")) +
  coord_flip() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4,size = 9.15))+ 
  scale_color_gradientn(colours  = material.heat(100)) +
  #scale_x_discrete(limits=rev) + scale_y_discrete(limits=rev) + 
  labs(title="CR7d intAnno1")
pn.intAnno1.test2b
```


```{r fig.height=10, fig.width=6, message=FALSE, warning=FALSE}
pn.intAnno2.test2b <- DotPlot(test2.seur, features = as.vector(unlist(markers.old.s)), group.by = "intAnno2",
        cols = c("midnightblue","darkorange1")) +
  coord_flip() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4,size = 9.15))+ 
  scale_color_gradientn(colours  = material.heat(100)) +
  #scale_x_discrete(limits=rev) + scale_y_discrete(limits=rev) + 
  labs(title="CR7d intAnno2")
pn.intAnno2.test2b
```


```{r eval=FALSE, include=FALSE}
#
ggsave("figures.integration/dotplot.old/dotplot.old_addAhr.CR7d_intAnno1.a.pdf",
       width = 12.75,height = 5,
       plot = pn.intAnno1.test2a)
ggsave("figures.integration/dotplot.old/dotplot.old_addAhr.CR7d_intAnno2.a.pdf",
       width = 12.75,height = 5.4,
       plot = pn.intAnno2.test2a)

#
ggsave("figures.integration/dotplot.old/dotplot.old_addAhr.CR7d_intAnno1.b.pdf",
       width = 6.5,height = 12,
       plot = pn.intAnno1.test2b)
ggsave("figures.integration/dotplot.old/dotplot.old_addAhr.CR7d_intAnno2.b.pdf",
       width = 7,height = 12,
       plot = pn.intAnno2.test2b)

```



```{r}
ref.seur <- readRDS("../../20230704_10x_SZJ/analysis_ref/GSE149524.P21.integration_Anno.s.rds")
ref.seur
```

```{r fig.width=10.5,fig.height=4.5}
DimPlot(ref.seur, reduction = "umap", label = T, group.by = "Anno1", cols = color.ref) +
  DimPlot(ref.seur, reduction = "umap", label = T, group.by = "Anno2")
```

```{r eval=FALSE, include=FALSE}
pdf("./figures.integration/umap.NatNeur2021_GSE149524.P21.integration.pdf",
    width = 11.5, height = 4.8)
DimPlot(ref.seur, reduction = "umap", label = T, group.by = "Anno1", cols = color.ref) +
  DimPlot(ref.seur, reduction = "umap", label = T, group.by = "Anno2")
dev.off()
```





```{r fig.height=4.75, fig.width=11.5, message=FALSE, warning=FALSE}
pn.ref.a <- DotPlot(ref.seur, features = as.vector(unlist(markers.old.s)), group.by = "Anno2",
        cols = c("midnightblue","darkorange1")) +
  #coord_flip() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1,size = 9.15))+ 
  scale_color_gradientn(colours  = material.heat(100)) +
  #scale_x_discrete(limits=rev) + 
  scale_y_discrete(limits=rev) + 
  labs(title="NatNeur2021 P21")
pn.ref.a
```

```{r fig.height=10, fig.width=5.5, message=FALSE, warning=FALSE}
pn.ref.b <- DotPlot(ref.seur, features = as.vector(unlist(markers.old.s)), group.by = "Anno2",
        cols = c("midnightblue","darkorange1")) +
  coord_flip() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4,size = 9.15))+ 
  scale_color_gradientn(colours  = material.heat(100)) +
  #scale_x_discrete(limits=rev) + scale_y_discrete(limits=rev) + 
  labs(title="NatNeur2021 P21")
pn.ref.b
```


```{r eval=FALSE, include=FALSE}
#
ggsave("figures.integration/dotplot.old/dotplot.old_addAhr.NatNeur2021.a.pdf",
       width = 12.75,height = 5.05,
       plot = pn.ref.a)

#
ggsave("figures.integration/dotplot.old/dotplot.old_addAhr.NatNeur2021.b.pdf",
       width = 6.25,height = 12,
       plot = pn.ref.b)


```


### short_new         


```{r}
markers.new.s <- list(EMN=c("Chat","Bnc2",#"Tox","Ptprt",
                       "Gfra2","Oprk1",#"Adamtsl1", 
                       "Fbxw15","Fbxw24",#"Chrna7",
                       "Satb1","Itga6","Cntnap5b",
                       "Chgb","Nxph1",
                       "Lama2","Efnb2","Itgb8",
                       "Lrrc7",
                       "Ryr3",#"Eda",
                       "Tac1",
                       #"Kctd8","Ntrk2",
                       "Penk",
                       "Fut9","Nfatc1","Egfr","Ahr"#"Mgll",
                       #"Chrm3"
                       ),
                 IMN=c("Nos1","Kcnab1",
                       "Gfra1","Etv1",
                       #"Man1a","Airn",
                       "Adcy2","Cmah","Col25a1",
                       "Mid1","Creb5","Vip","Pde1a",
                       "Ebf1",#,"Gpc5"
                       "Ppara","Pcdh11x",
                       "Adcy8","Grp"
                       ),
                 IN=c("Npas3","Synpr","St18","Gal",
                      "Cdh10","Neurod6",
                      "Kcnk13",
                      "Moxd1","Sctr",
                      "Piezo1","Vipr2","Sst",#"Adamts9",
                      "Kcnn2"
                      ),
                 IPAN=c("Calb2","Adcy1",
                        "Nmu","Adgrg6",#"Pcdh10",
                        "Ngfr","Il7",
                        "Itgb6","Calcb","Galr1",
                        #"Aff2",
                        #"Gpr149",
                        "Met",
                        "Cpne4","Cdh6","Cdh8",
                        "Clstn2",#"Ano2","Ntrk3",
                        #"Vwc2l",
                        "Car10","Scgn","Glp2r","Cck",
                        "Cdh9",
                        #"Vcan",
                        "Dcc",
                        "Gabrb1",
                        "Piezo2","Kcnh7",
                        #"Rerg",
                        "Bmpr1b","Ntng1","Skap1",
                        "Tafa2","Nxph2"))
```


```{r eval=FALSE, include=FALSE}
sink("./figures.integration/dotplot.new/final_markers.new_addAhr.dotplot_short.csv")

markers.new.s

sink()
```


```{r fig.height=4.75, fig.width=14.5, message=FALSE, warning=FALSE}
pm.intAnno1.test0a <- DotPlot(GEX.seur, features = as.vector(unlist(markers.new.s)), group.by = "intAnno1",
        cols = c("midnightblue","darkorange1")) +
  #coord_flip() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1,size = 9.15))+ 
  scale_color_gradientn(colours  = material.heat(100)) +
  #scale_x_discrete(limits=rev) + 
  scale_y_discrete(limits=rev) + 
  labs(title="All intAnno1")
pm.intAnno1.test0a
```


```{r fig.height=5, fig.width=14.5, message=FALSE, warning=FALSE}
pm.intAnno2.test0a <- DotPlot(GEX.seur, features = as.vector(unlist(markers.new.s)), group.by = "intAnno2",
        cols = c("midnightblue","darkorange1")) +
  #coord_flip() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1,size = 9.15))+ 
  scale_color_gradientn(colours  = material.heat(100)) +
  #scale_x_discrete(limits=rev) + 
  scale_y_discrete(limits=rev) + 
  labs(title="All intAnno2")
pm.intAnno2.test0a
```

```{r fig.height=13.5, fig.width=6, message=FALSE, warning=FALSE}
pm.intAnno1.test0b <- DotPlot(GEX.seur, features = as.vector(unlist(markers.new.s)), group.by = "intAnno1",
        cols = c("midnightblue","darkorange1")) +
  coord_flip() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4,size = 9.15))+ 
  scale_color_gradientn(colours  = material.heat(100)) +
  #scale_x_discrete(limits=rev) + scale_y_discrete(limits=rev) + 
  labs(title="All intAnno1")
pm.intAnno1.test0b
```


```{r fig.height=13.5, fig.width=6, message=FALSE, warning=FALSE}
pm.intAnno2.test0b <- DotPlot(GEX.seur, features = as.vector(unlist(markers.new.s)), group.by = "intAnno2",
        cols = c("midnightblue","darkorange1")) +
  coord_flip() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4,size = 9.15))+ 
  scale_color_gradientn(colours  = material.heat(100)) +
  #scale_x_discrete(limits=rev) + scale_y_discrete(limits=rev) + 
  labs(title="All intAnno2")
pm.intAnno2.test0b
```


```{r eval=FALSE, include=FALSE}
#
ggsave("figures.integration/dotplot.new/dotplot.new_addAhr.All_intAnno1.a.pdf",
       width = 15.5,height = 5,
       plot = pm.intAnno1.test0a)
ggsave("figures.integration/dotplot.new/dotplot.new_addAhr.All_intAnno2.a.pdf",
       width = 15.5,height = 5.4,
       plot = pm.intAnno2.test0a)

#
ggsave("figures.integration/dotplot.new/dotplot.new_addAhr.All_intAnno1.b.pdf",
       width = 6.5,height = 15,
       plot = pm.intAnno1.test0b)
ggsave("figures.integration/dotplot.new/dotplot.new_addAhr.All_intAnno2.b.pdf",
       width = 7,height = 15,
       plot = pm.intAnno2.test0b)

```


```{r fig.height=4.75, fig.width=14.5, message=FALSE, warning=FALSE}
pm.intAnno1.test1a <- DotPlot(test1.seur, features = as.vector(unlist(markers.new.s)), group.by = "intAnno1",
        cols = c("midnightblue","darkorange1")) +
  #coord_flip() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1,size = 9.15))+ 
  scale_color_gradientn(colours  = material.heat(100)) +
  #scale_x_discrete(limits=rev) + 
  scale_y_discrete(limits=rev) + 
  labs(title="Stst intAnno1")
pm.intAnno1.test1a
```

```{r fig.height=5, fig.width=14.5, message=FALSE, warning=FALSE}
pm.intAnno2.test1a <- DotPlot(test1.seur, features = as.vector(unlist(markers.new.s)), group.by = "intAnno2",
        cols = c("midnightblue","darkorange1")) +
  #coord_flip() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1,size = 9.15))+ 
  scale_color_gradientn(colours  = material.heat(100)) +
  #scale_x_discrete(limits=rev) + 
  scale_y_discrete(limits=rev) + 
  labs(title="Stst intAnno2")
pm.intAnno2.test1a
```

```{r fig.height=13.5, fig.width=6, message=FALSE, warning=FALSE}
pm.intAnno1.test1b <- DotPlot(test1.seur, features = as.vector(unlist(markers.new.s)), group.by = "intAnno1",
        cols = c("midnightblue","darkorange1")) +
  coord_flip() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4,size = 9.15))+ 
  scale_color_gradientn(colours  = material.heat(100)) +
  #scale_x_discrete(limits=rev) + scale_y_discrete(limits=rev) + 
  labs(title="Stst intAnno1")
pm.intAnno1.test1b
```

```{r fig.height=13.5, fig.width=6, message=FALSE, warning=FALSE}
pm.intAnno2.test1b <- DotPlot(test1.seur, features = as.vector(unlist(markers.new.s)), group.by = "intAnno2",
        cols = c("midnightblue","darkorange1")) +
  coord_flip() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4,size = 9.15))+ 
  scale_color_gradientn(colours  = material.heat(100)) +
  #scale_x_discrete(limits=rev) + scale_y_discrete(limits=rev) + 
  labs(title="Stst intAnno2")
pm.intAnno2.test1b
```


```{r eval=FALSE, include=FALSE}
#
ggsave("figures.integration/dotplot.new/dotplot.new_addAhr.Stst_intAnno1.a.pdf",
       width = 15.5,height = 5,
       plot = pm.intAnno1.test1a)
ggsave("figures.integration/dotplot.new/dotplot.new_addAhr.Stst_intAnno2.a.pdf",
       width = 15.5,height = 5.4,
       plot = pm.intAnno2.test1a)

#
ggsave("figures.integration/dotplot.new/dotplot.new_addAhr.Stst_intAnno1.b.pdf",
       width = 6.5,height = 15,
       plot = pm.intAnno1.test1b)
ggsave("figures.integration/dotplot.new/dotplot.new_addAhr.Stst_intAnno2.b.pdf",
       width = 7,height = 15,
       plot = pm.intAnno2.test1b)

```


```{r fig.height=4.75, fig.width=14.5, message=FALSE, warning=FALSE}
pm.intAnno1.test2a <- DotPlot(test2.seur, features = as.vector(unlist(markers.new.s)), group.by = "intAnno1",
        cols = c("midnightblue","darkorange1")) +
  #coord_flip() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1,size = 9.15))+ 
  scale_color_gradientn(colours  = material.heat(100)) +
  #scale_x_discrete(limits=rev) + 
  scale_y_discrete(limits=rev) + 
  labs(title="CR7d intAnno1")
pm.intAnno1.test2a
```


```{r fig.height=5, fig.width=14.5, message=FALSE, warning=FALSE}
pm.intAnno2.test2a <- DotPlot(test2.seur, features = as.vector(unlist(markers.new.s)), group.by = "intAnno2",
        cols = c("midnightblue","darkorange1")) +
  #coord_flip() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1,size = 9.15))+ 
  scale_color_gradientn(colours  = material.heat(100)) +
  #scale_x_discrete(limits=rev) + 
  scale_y_discrete(limits=rev) + 
  labs(title="CR7d intAnno2")
pm.intAnno2.test2a
```


```{r fig.height=13.5, fig.width=6, message=FALSE, warning=FALSE}
pm.intAnno1.test2b <- DotPlot(test2.seur, features = as.vector(unlist(markers.new.s)), group.by = "intAnno1",
        cols = c("midnightblue","darkorange1")) +
  coord_flip() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4,size = 9.15))+ 
  scale_color_gradientn(colours  = material.heat(100)) +
  #scale_x_discrete(limits=rev) + scale_y_discrete(limits=rev) + 
  labs(title="CR7d intAnno1")
pm.intAnno1.test2b
```


```{r fig.height=13.5, fig.width=6, message=FALSE, warning=FALSE}
pm.intAnno2.test2b <- DotPlot(test2.seur, features = as.vector(unlist(markers.new.s)), group.by = "intAnno2",
        cols = c("midnightblue","darkorange1")) +
  coord_flip() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4,size = 9.15))+ 
  scale_color_gradientn(colours  = material.heat(100)) +
  #scale_x_discrete(limits=rev) + scale_y_discrete(limits=rev) + 
  labs(title="CR7d intAnno2")
pm.intAnno2.test2b
```


```{r eval=FALSE, include=FALSE}
#
ggsave("figures.integration/dotplot.new/dotplot.new_addAhr.CR7d_intAnno1.a.pdf",
       width = 15.5,height = 5,
       plot = pm.intAnno1.test2a)
ggsave("figures.integration/dotplot.new/dotplot.new_addAhr.CR7d_intAnno2.a.pdf",
       width = 15.5,height = 5.4,
       plot = pm.intAnno2.test2a)

#
ggsave("figures.integration/dotplot.new/dotplot.new_addAhr.CR7d_intAnno1.b.pdf",
       width = 6.5,height = 15,
       plot = pm.intAnno1.test2b)
ggsave("figures.integration/dotplot.new/dotplot.new_addAhr.CR7d_intAnno2.b.pdf",
       width = 7,height = 15,
       plot = pm.intAnno2.test2b)

```



```{r fig.height=4.75, fig.width=15.5, message=FALSE, warning=FALSE}
pm.ref.a <- DotPlot(ref.seur, features = as.vector(unlist(markers.new.s)), group.by = "Anno2",
        cols = c("midnightblue","darkorange1")) +
  #coord_flip() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1,size = 9.15))+ 
  scale_color_gradientn(colours  = material.heat(100)) +
  #scale_x_discrete(limits=rev) + 
  scale_y_discrete(limits=rev) + 
  labs(title="NatNeur2021 P21")
pm.ref.a
```

```{r fig.height=15, fig.width=5.5, message=FALSE, warning=FALSE}
pm.ref.b <- DotPlot(ref.seur, features = as.vector(unlist(markers.new.s)), group.by = "Anno2",
        cols = c("midnightblue","darkorange1")) +
  coord_flip() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4,size = 9.15))+ 
  scale_color_gradientn(colours  = material.heat(100)) +
  #scale_x_discrete(limits=rev) + scale_y_discrete(limits=rev) + 
  labs(title="NatNeur2021 P21")
pm.ref.b
```


```{r eval=FALSE, include=FALSE}
#
ggsave("figures.integration/dotplot.new/dotplot.new_addAhr.NatNeur2021.a.pdf",
       width = 15.5,height = 5.05,
       plot = pm.ref.a)

#
ggsave("figures.integration/dotplot.new/dotplot.new_addAhr.NatNeur2021.b.pdf",
       width = 6.25,height = 15,
       plot = pm.ref.b)


```



## signature scores                 
           
              
### top list             

use top120-built top markers                     


```{r}
load("I:/Shared_win/projects/20231220_10x_SZJ/analysis_plus/top.markerlist.RData")
```


```{r paged.print=FALSE}
data.frame(row.names = "topmarkers",lapply(top.list,length))
```


```{r}
for(nn in neur.clusters){
  
  GEX.seur <- add_geneset_score(obj = GEX.seur,
                                Assay = "SCT",
                                geneset = top.list[[nn]],
                                setname = paste0("score.",nn))
  
}
```


```{r fig.height=10, fig.width=15.5, message=FALSE, warning=FALSE}
mapal <- colorRampPalette(RColorBrewer::brewer.pal(4,"Spectral"))(120)
FeaturePlot(GEX.seur, features = paste0("score.",neur.clusters), ncol = 5) &
  scale_color_gradientn(colors = rev(mapal))
```


```{r fig.height=10, fig.width=15.5, message=FALSE, warning=FALSE}
mapal <- colorRampPalette(RColorBrewer::brewer.pal(4,"Spectral"))(120)
FeaturePlot(GEX.seur, features = paste0("score.",neur.clusters), ncol = 5, raster = T, pt.size = 3.5) &
  scale_color_gradientn(colors = rev(mapal))
```


```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
ggsave("./markers/sig.markers/sig.markers.pdf",
       width = 15.5, height = 10,
FeaturePlot(GEX.seur, features = paste0("score.",neur.clusters), ncol = 5, raster = T, pt.size = 3.5) &
  scale_color_gradientn(colors = rev(mapal)))
```



## check some markers                

### Nmu             


```{r message=FALSE, warning=FALSE}
check.m <- "Nmu"

#
VlnPlot(test1.seur, features = check.m, group.by = "intAnno1", assay = "RNA") + NoLegend() + labs(x="Stst") +
  scale_fill_manual(values = color.A1)

VlnPlot(test1.seur, features = check.m, group.by = "intAnno1", assay = "RNA", split.by = "cnt") + NoLegend() + labs(x="Stst") +
  scale_fill_manual(values = color.test1)

#
VlnPlot(test2.seur, features = check.m, group.by = "intAnno1", assay = "RNA") + NoLegend() + labs(x="CR7d") +
  scale_fill_manual(values = color.A1)

VlnPlot(test2.seur, features = check.m, group.by = "intAnno1", assay = "RNA", split.by = "cnt") + NoLegend() + labs(x="CR7d") +
  scale_fill_manual(values = color.test2)
```


```{r message=FALSE, warning=FALSE, fig.width=4, fig.height=4.5}
##
# use coord_cartesian(ylim()) instead of ylim()

VlnPlot(test1.seur, features = check.m, group.by = "cnt", cols = color.test1, pt.size = 0, assay = "RNA") + NoLegend() &
  geom_jitter(alpha=0.25, shape=16, width = 0.3, size = 0.25) & labs(title = paste0("All - ",check.m), x="") &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55) & coord_cartesian(ylim = c(0,4.5)) & 
  ggpubr::stat_compare_means(aes(lable = ..p.signif..), 
                               method = "wilcox.test",
                               comparisons = list(c("Stst.CTL","Stst.CKO")),
                               label.y = c(3.5),
                               size=3.5
                               )

#
VlnPlot(subset(test1.seur, subset=intAnno1 %in% c("IPAN1")), features = check.m, group.by = "cnt", cols = color.test1, pt.size = 0, assay = "RNA") + NoLegend() &
  geom_jitter(alpha=0.25, shape=16, width = 0.3, size = 0.25) & labs(title = paste0("IPAN1 - ",check.m), x="") &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55) & coord_cartesian(ylim = c(0,4.5)) & 
  ggpubr::stat_compare_means(aes(lable = ..p.signif..), 
                               method = "wilcox.test",
                               comparisons = list(c("Stst.CTL","Stst.CKO")),
                               label.y = c(3.5),
                               size=3.5
                               ) 

VlnPlot(subset(test1.seur, subset=intAnno2 %in% c("IPAN1.1")), features = check.m, group.by = "cnt", cols = color.test1, pt.size = 0, assay = "RNA") + NoLegend() &
  geom_jitter(alpha=0.25, shape=16, width = 0.3, size = 0.25) & labs(title = paste0("IPAN1.1 - ",check.m), x="") &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55) & coord_cartesian(ylim = c(0,4.5)) & 
  ggpubr::stat_compare_means(aes(lable = ..p.signif..), 
                               method = "wilcox.test",
                               comparisons = list(c("Stst.CTL","Stst.CKO")),
                               label.y = c(3.5),
                               size=3.5
                               )

VlnPlot(subset(test1.seur, subset=intAnno2 %in% c("IPAN1.2")), features = check.m, group.by = "cnt", cols = color.test1, pt.size = 0, assay = "RNA") + NoLegend() &
  geom_jitter(alpha=0.25, shape=16, width = 0.3, size = 0.25) & labs(title = paste0("IPAN1.2 - ",check.m), x="") &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55) & coord_cartesian(ylim = c(0,4.5)) & 
  ggpubr::stat_compare_means(aes(lable = ..p.signif..), 
                               method = "wilcox.test",
                               comparisons = list(c("Stst.CTL","Stst.CKO")),
                               label.y = c(3.5),
                               size=3.5
                               )
```


```{r message=FALSE, warning=FALSE, fig.width=4, fig.height=4.5}
##
# use coord_cartesian(ylim()) instead of ylim()

VlnPlot(test2.seur, features = check.m, group.by = "cnt", cols = color.test2, pt.size = 0, assay = "RNA") + NoLegend() &
  geom_jitter(alpha=0.25, shape=16, width = 0.3, size = 0.25) & labs(title = paste0("All - ",check.m), x="") &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55) & coord_cartesian(ylim = c(0,4.5)) & 
  ggpubr::stat_compare_means(aes(lable = ..p.signif..), 
                               method = "wilcox.test",
                               comparisons = list(c("CR7d.CTL","CR7d.CKO")),
                               label.y = c(3.5),
                               size=3.5
                               )

#
VlnPlot(subset(test2.seur, subset=intAnno1 %in% c("IPAN1")), features = check.m, group.by = "cnt", cols = color.test2, pt.size = 0, assay = "RNA") + NoLegend() &
  geom_jitter(alpha=0.25, shape=16, width = 0.3, size = 0.25) & labs(title = paste0("IPAN1 - ",check.m), x="") &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55) & coord_cartesian(ylim = c(0,4.5)) & 
  ggpubr::stat_compare_means(aes(lable = ..p.signif..), 
                               method = "wilcox.test",
                               comparisons = list(c("CR7d.CTL","CR7d.CKO")),
                               label.y = c(3.5),
                               size=3.5
                               )

VlnPlot(subset(test2.seur, subset=intAnno2 %in% c("IPAN1.1")), features = check.m, group.by = "cnt", cols = color.test2, pt.size = 0, assay = "RNA") + NoLegend() &
  geom_jitter(alpha=0.25, shape=16, width = 0.3, size = 0.25) & labs(title = paste0("IPAN1.1 - ",check.m), x="") &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55) & coord_cartesian(ylim = c(0,4.5)) & 
  ggpubr::stat_compare_means(aes(lable = ..p.signif..), 
                               method = "wilcox.test",
                               comparisons = list(c("CR7d.CTL","CR7d.CKO")),
                               label.y = c(3.5),
                               size=3.5
                               )

VlnPlot(subset(test2.seur, subset=intAnno2 %in% c("IPAN1.2")), features = check.m, group.by = "cnt", cols = color.test2, pt.size = 0, assay = "RNA") + NoLegend() &
  geom_jitter(alpha=0.25, shape=16, width = 0.3, size = 0.25) & labs(title = paste0("IPAN1.2 - ",check.m), x="") &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55) & coord_cartesian(ylim = c(0,4.5)) & 
  ggpubr::stat_compare_means(aes(lable = ..p.signif..), 
                               method = "wilcox.test",
                               comparisons = list(c("CR7d.CTL","CR7d.CKO")),
                               label.y = c(3.5),
                               size=3.5
                               )
```


### Calcb                    


```{r message=FALSE, warning=FALSE, fig.width=12, fig.height=7.6}
check.m <- "Calcb"

#
cowplot::plot_grid(
VlnPlot(test1.seur, features = check.m, group.by = "intAnno1", assay = "RNA") + NoLegend() + labs(x="Stst") +
  scale_fill_manual(values = color.A1),

VlnPlot(test2.seur, features = check.m, group.by = "intAnno1", assay = "RNA") + NoLegend() + labs(x="CR7d") +
  scale_fill_manual(values = color.A1),

VlnPlot(test1.seur, features = check.m, group.by = "intAnno1", assay = "RNA", split.by = "cnt") + NoLegend() + labs(x="Stst") +
  scale_fill_manual(values = color.test1),

VlnPlot(test2.seur, features = check.m, group.by = "intAnno1", assay = "RNA", split.by = "cnt") + NoLegend() + labs(x="CR7d") +
  scale_fill_manual(values = color.test2),
#
ncol = 2)

```


```{r message=FALSE, warning=FALSE, fig.width=8, fig.height=9}
##
# use coord_cartesian(ylim()) instead of ylim()

cowplot::plot_grid(
VlnPlot(test1.seur, features = check.m, group.by = "cnt", cols = color.test1, pt.size = 0, assay = "RNA") + NoLegend() &
  geom_jitter(alpha=0.25, shape=16, width = 0.3, size = 0.25) & labs(title = paste0("All - ",check.m), x="") &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55) & coord_cartesian(ylim = c(0,3.5)) & 
  ggpubr::stat_compare_means(aes(lable = ..p.signif..), 
                               method = "wilcox.test",
                               comparisons = list(c("Stst.CTL","Stst.CKO")),
                               label.y = c(2.75),
                               size=3.5
                               ),

#
VlnPlot(subset(test1.seur, subset=intAnno1 %in% c("IPAN1")), features = check.m, group.by = "cnt", cols = color.test1, pt.size = 0, assay = "RNA") + NoLegend() &
  geom_jitter(alpha=0.25, shape=16, width = 0.3, size = 0.25) & labs(title = paste0("IPAN1 - ",check.m), x="") &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55) & coord_cartesian(ylim = c(0,3.5)) & 
  ggpubr::stat_compare_means(aes(lable = ..p.signif..), 
                               method = "wilcox.test",
                               comparisons = list(c("Stst.CTL","Stst.CKO")),
                               label.y = c(2.75),
                               size=3.5
                               ) ,

VlnPlot(subset(test1.seur, subset=intAnno2 %in% c("IPAN1.1")), features = check.m, group.by = "cnt", cols = color.test1, pt.size = 0, assay = "RNA") + NoLegend() &
  geom_jitter(alpha=0.25, shape=16, width = 0.3, size = 0.25) & labs(title = paste0("IPAN1.1 - ",check.m), x="") &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55) & coord_cartesian(ylim = c(0,3.5)) & 
  ggpubr::stat_compare_means(aes(lable = ..p.signif..), 
                               method = "wilcox.test",
                               comparisons = list(c("Stst.CTL","Stst.CKO")),
                               label.y = c(2.75),
                               size=3.5
                               ),

VlnPlot(subset(test1.seur, subset=intAnno2 %in% c("IPAN1.2")), features = check.m, group.by = "cnt", cols = color.test1, pt.size = 0, assay = "RNA") + NoLegend() &
  geom_jitter(alpha=0.25, shape=16, width = 0.3, size = 0.25) & labs(title = paste0("IPAN1.2 - ",check.m), x="") &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55) & coord_cartesian(ylim = c(0,3.5)) & 
  ggpubr::stat_compare_means(aes(lable = ..p.signif..), 
                               method = "wilcox.test",
                               comparisons = list(c("Stst.CTL","Stst.CKO")),
                               label.y = c(2.75),
                               size=3.5
                               ),
ncol = 2)
```


```{r message=FALSE, warning=FALSE, fig.width=8, fig.height=9}
##
# use coord_cartesian(ylim()) instead of ylim()
cowplot::plot_grid(
VlnPlot(test2.seur, features = check.m, group.by = "cnt", cols = color.test2, pt.size = 0, assay = "RNA") + NoLegend() &
  geom_jitter(alpha=0.25, shape=16, width = 0.3, size = 0.25) & labs(title = paste0("All - ",check.m), x="") &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55) & coord_cartesian(ylim = c(0,3.5)) & 
  ggpubr::stat_compare_means(aes(lable = ..p.signif..), 
                               method = "wilcox.test",
                               comparisons = list(c("CR7d.CTL","CR7d.CKO")),
                               label.y = c(2.75),
                               size=3.5
                               ),

#
VlnPlot(subset(test2.seur, subset=intAnno1 %in% c("IPAN1")), features = check.m, group.by = "cnt", cols = color.test2, pt.size = 0, assay = "RNA") + NoLegend() &
  geom_jitter(alpha=0.25, shape=16, width = 0.3, size = 0.25) & labs(title = paste0("IPAN1 - ",check.m), x="") &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55) & coord_cartesian(ylim = c(0,3.5)) & 
  ggpubr::stat_compare_means(aes(lable = ..p.signif..), 
                               method = "wilcox.test",
                               comparisons = list(c("CR7d.CTL","CR7d.CKO")),
                               label.y = c(2.75),
                               size=3.5
                               ),

VlnPlot(subset(test2.seur, subset=intAnno2 %in% c("IPAN1.1")), features = check.m, group.by = "cnt", cols = color.test2, pt.size = 0, assay = "RNA") + NoLegend() &
  geom_jitter(alpha=0.25, shape=16, width = 0.3, size = 0.25) & labs(title = paste0("IPAN1.1 - ",check.m), x="") &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55) & coord_cartesian(ylim = c(0,3.5)) & 
  ggpubr::stat_compare_means(aes(lable = ..p.signif..), 
                               method = "wilcox.test",
                               comparisons = list(c("CR7d.CTL","CR7d.CKO")),
                               label.y = c(2.75),
                               size=3.5
                               ),

VlnPlot(subset(test2.seur, subset=intAnno2 %in% c("IPAN1.2")), features = check.m, group.by = "cnt", cols = color.test2, pt.size = 0, assay = "RNA") + NoLegend() &
  geom_jitter(alpha=0.25, shape=16, width = 0.3, size = 0.25) & labs(title = paste0("IPAN1.2 - ",check.m), x="") &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55) & coord_cartesian(ylim = c(0,3.5)) & 
  ggpubr::stat_compare_means(aes(lable = ..p.signif..), 
                               method = "wilcox.test",
                               comparisons = list(c("CR7d.CTL","CR7d.CKO")),
                               label.y = c(2.75),
                               size=3.5
                               ),
ncol = 2)
```


```{r message=FALSE, warning=FALSE, fig.width=8, fig.height=9}
##
# use coord_cartesian(ylim()) instead of ylim()

cowplot::plot_grid(
VlnPlot(test1.seur, features = check.m, group.by = "cnt", cols = color.test1, pt.size = 0, assay = "SCT") + NoLegend() &
  geom_jitter(alpha=0.25, shape=16, width = 0.3, size = 0.25) & labs(title = paste0("All - ",check.m), x="") &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55) & coord_cartesian(ylim = c(0,2)) & 
  ggpubr::stat_compare_means(aes(lable = ..p.signif..), 
                               method = "wilcox.test",
                               comparisons = list(c("Stst.CTL","Stst.CKO")),
                               label.y = c(1.5),
                               size=3.5
                               ),

#
VlnPlot(subset(test1.seur, subset=intAnno1 %in% c("IPAN1")), features = check.m, group.by = "cnt", cols = color.test1, pt.size = 0, assay = "SCT") + NoLegend() &
  geom_jitter(alpha=0.25, shape=16, width = 0.3, size = 0.25) & labs(title = paste0("IPAN1 - ",check.m), x="") &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55) & coord_cartesian(ylim = c(0,2)) & 
  ggpubr::stat_compare_means(aes(lable = ..p.signif..), 
                               method = "wilcox.test",
                               comparisons = list(c("Stst.CTL","Stst.CKO")),
                               label.y = c(1.5),
                               size=3.5
                               ) ,

VlnPlot(subset(test1.seur, subset=intAnno2 %in% c("IPAN1.1")), features = check.m, group.by = "cnt", cols = color.test1, pt.size = 0, assay = "SCT") + NoLegend() &
  geom_jitter(alpha=0.25, shape=16, width = 0.3, size = 0.25) & labs(title = paste0("IPAN1.1 - ",check.m), x="") &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55) & coord_cartesian(ylim = c(0,2)) & 
  ggpubr::stat_compare_means(aes(lable = ..p.signif..), 
                               method = "wilcox.test",
                               comparisons = list(c("Stst.CTL","Stst.CKO")),
                               label.y = c(1.5),
                               size=3.5
                               ),

VlnPlot(subset(test1.seur, subset=intAnno2 %in% c("IPAN1.2")), features = check.m, group.by = "cnt", cols = color.test1, pt.size = 0, assay = "SCT") + NoLegend() &
  geom_jitter(alpha=0.25, shape=16, width = 0.3, size = 0.25) & labs(title = paste0("IPAN1.2 - ",check.m), x="") &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55) & coord_cartesian(ylim = c(0,2)) & 
  ggpubr::stat_compare_means(aes(lable = ..p.signif..), 
                               method = "wilcox.test",
                               comparisons = list(c("Stst.CTL","Stst.CKO")),
                               label.y = c(1.5),
                               size=3.5
                               ),
ncol = 2)
```

```{r message=FALSE, warning=FALSE, fig.width=8, fig.height=9}
##
# use coord_cartesian(ylim()) instead of ylim()
cowplot::plot_grid(
VlnPlot(test2.seur, features = check.m, group.by = "cnt", cols = color.test2, pt.size = 0, assay = "SCT") + NoLegend() &
  geom_jitter(alpha=0.25, shape=16, width = 0.3, size = 0.25) & labs(title = paste0("All - ",check.m), x="") &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55) & coord_cartesian(ylim = c(0,2)) & 
  ggpubr::stat_compare_means(aes(lable = ..p.signif..), 
                               method = "wilcox.test",
                               comparisons = list(c("CR7d.CTL","CR7d.CKO")),
                               label.y = c(1.45),
                               size=3.5
                               ),

#
VlnPlot(subset(test2.seur, subset=intAnno1 %in% c("IPAN1")), features = check.m, group.by = "cnt", cols = color.test2, pt.size = 0, assay = "SCT") + NoLegend() &
  geom_jitter(alpha=0.25, shape=16, width = 0.3, size = 0.25) & labs(title = paste0("IPAN1 - ",check.m), x="") &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55) & coord_cartesian(ylim = c(0,2)) & 
  ggpubr::stat_compare_means(aes(lable = ..p.signif..), 
                               method = "wilcox.test",
                               comparisons = list(c("CR7d.CTL","CR7d.CKO")),
                               label.y = c(1.45),
                               size=3.5
                               ),

VlnPlot(subset(test2.seur, subset=intAnno2 %in% c("IPAN1.1")), features = check.m, group.by = "cnt", cols = color.test2, pt.size = 0, assay = "SCT") + NoLegend() &
  geom_jitter(alpha=0.25, shape=16, width = 0.3, size = 0.25) & labs(title = paste0("IPAN1.1 - ",check.m), x="") &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55) & coord_cartesian(ylim = c(0,2)) & 
  ggpubr::stat_compare_means(aes(lable = ..p.signif..), 
                               method = "wilcox.test",
                               comparisons = list(c("CR7d.CTL","CR7d.CKO")),
                               label.y = c(1.25),
                               size=3.5
                               ),

VlnPlot(subset(test2.seur, subset=intAnno2 %in% c("IPAN1.2")), features = check.m, group.by = "cnt", cols = color.test2, pt.size = 0, assay = "SCT") + NoLegend() &
  geom_jitter(alpha=0.25, shape=16, width = 0.3, size = 0.25) & labs(title = paste0("IPAN1.2 - ",check.m), x="") &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55) & coord_cartesian(ylim = c(0,2)) & 
  ggpubr::stat_compare_means(aes(lable = ..p.signif..), 
                               method = "wilcox.test",
                               comparisons = list(c("CR7d.CTL","CR7d.CKO")),
                               label.y = c(1.45),
                               size=3.5
                               ),
ncol = 2)
```


### Gal                    


```{r message=FALSE, warning=FALSE, fig.width=12, fig.height=7.6}
check.m <- "Gal"

#
cowplot::plot_grid(
VlnPlot(test1.seur, features = check.m, group.by = "intAnno1", assay = "RNA") + NoLegend() + labs(x="Stst") +
  scale_fill_manual(values = color.A1),

VlnPlot(test2.seur, features = check.m, group.by = "intAnno1", assay = "RNA") + NoLegend() + labs(x="CR7d") +
  scale_fill_manual(values = color.A1),

VlnPlot(test1.seur, features = check.m, group.by = "intAnno1", assay = "RNA", split.by = "cnt") + NoLegend() + labs(x="Stst") +
  scale_fill_manual(values = color.test1),

VlnPlot(test2.seur, features = check.m, group.by = "intAnno1", assay = "RNA", split.by = "cnt") + NoLegend() + labs(x="CR7d") +
  scale_fill_manual(values = color.test2),
#
ncol = 2)

```


```{r message=FALSE, warning=FALSE, fig.width=8, fig.height=9}
##
# use coord_cartesian(ylim()) instead of ylim()

cowplot::plot_grid(
VlnPlot(test1.seur, features = check.m, group.by = "cnt", cols = color.test1, pt.size = 0, assay = "RNA") + NoLegend() &
  geom_jitter(alpha=0.25, shape=16, width = 0.3, size = 0.25) & labs(title = paste0("All - ",check.m), x="") &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55) & coord_cartesian(ylim = c(0,6)) & 
  ggpubr::stat_compare_means(aes(lable = ..p.signif..), 
                               method = "wilcox.test",
                               comparisons = list(c("Stst.CTL","Stst.CKO")),
                               label.y = c(4.5),
                               size=3.5
                               ),

#
VlnPlot(subset(test1.seur, subset=intAnno1 %in% c("IN1")), features = check.m, group.by = "cnt", cols = color.test1, pt.size = 0, assay = "RNA") + NoLegend() &
  geom_jitter(alpha=0.25, shape=16, width = 0.3, size = 0.25) & labs(title = paste0("IN1 - ",check.m), x="") &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55) & coord_cartesian(ylim = c(0,6)) & 
  ggpubr::stat_compare_means(aes(lable = ..p.signif..), 
                               method = "wilcox.test",
                               comparisons = list(c("Stst.CTL","Stst.CKO")),
                               label.y = c(4.5),
                               size=3.5
                               ) ,

VlnPlot(subset(test1.seur, subset=intAnno2 %in% c("IN2")), features = check.m, group.by = "cnt", cols = color.test1, pt.size = 0, assay = "RNA") + NoLegend() &
  geom_jitter(alpha=0.25, shape=16, width = 0.3, size = 0.25) & labs(title = paste0("IN2 - ",check.m), x="") &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55) & coord_cartesian(ylim = c(0,6)) & 
  ggpubr::stat_compare_means(aes(lable = ..p.signif..), 
                               method = "wilcox.test",
                               comparisons = list(c("Stst.CTL","Stst.CKO")),
                               label.y = c(4.5),
                               size=3.5
                               ),

VlnPlot(subset(test1.seur, subset=intAnno2 %in% c("IMN3")), features = check.m, group.by = "cnt", cols = color.test1, pt.size = 0, assay = "RNA") + NoLegend() &
  geom_jitter(alpha=0.25, shape=16, width = 0.3, size = 0.25) & labs(title = paste0("IMN3 - ",check.m), x="") &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55) & coord_cartesian(ylim = c(0,6)) & 
  ggpubr::stat_compare_means(aes(lable = ..p.signif..), 
                               method = "wilcox.test",
                               comparisons = list(c("Stst.CTL","Stst.CKO")),
                               label.y = c(2.75),
                               size=3.5
                               ),
ncol = 2)
```

```{r message=FALSE, warning=FALSE, fig.width=8, fig.height=9}
##
# use coord_cartesian(ylim()) instead of ylim()

cowplot::plot_grid(
VlnPlot(test2.seur, features = check.m, group.by = "cnt", cols = color.test2, pt.size = 0, assay = "RNA") + NoLegend() &
  geom_jitter(alpha=0.25, shape=16, width = 0.3, size = 0.25) & labs(title = paste0("All - ",check.m), x="") &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55) & coord_cartesian(ylim = c(0,6)) & 
  ggpubr::stat_compare_means(aes(lable = ..p.signif..), 
                               method = "wilcox.test",
                               comparisons = list(c("CR7d.CTL","CR7d.CKO")),
                               label.y = c(4.5),
                               size=3.5
                               ),

#
VlnPlot(subset(test2.seur, subset=intAnno1 %in% c("IN1")), features = check.m, group.by = "cnt", cols = color.test2, pt.size = 0, assay = "RNA") + NoLegend() &
  geom_jitter(alpha=0.25, shape=16, width = 0.3, size = 0.25) & labs(title = paste0("IN1 - ",check.m), x="") &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55) & coord_cartesian(ylim = c(0,6)) & 
  ggpubr::stat_compare_means(aes(lable = ..p.signif..), 
                               method = "wilcox.test",
                               comparisons = list(c("CR7d.CTL","CR7d.CKO")),
                               label.y = c(4.5),
                               size=3.5
                               ) ,

VlnPlot(subset(test2.seur, subset=intAnno2 %in% c("IN2")), features = check.m, group.by = "cnt", cols = color.test2, pt.size = 0, assay = "RNA") + NoLegend() &
  geom_jitter(alpha=0.25, shape=16, width = 0.3, size = 0.25) & labs(title = paste0("IN2 - ",check.m), x="") &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55) & coord_cartesian(ylim = c(0,6)) & 
  ggpubr::stat_compare_means(aes(lable = ..p.signif..), 
                               method = "wilcox.test",
                               comparisons = list(c("CR7d.CTL","CR7d.CKO")),
                               label.y = c(4.5),
                               size=3.5
                               ),

VlnPlot(subset(test2.seur, subset=intAnno2 %in% c("IMN3")), features = check.m, group.by = "cnt", cols = color.test2, pt.size = 0, assay = "RNA") + NoLegend() &
  geom_jitter(alpha=0.25, shape=16, width = 0.3, size = 0.25) & labs(title = paste0("IMN3 - ",check.m), x="") &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55) & coord_cartesian(ylim = c(0,6)) & 
  ggpubr::stat_compare_means(aes(lable = ..p.signif..), 
                               method = "wilcox.test",
                               comparisons = list(c("CR7d.CTL","CR7d.CKO")),
                               label.y = c(2.75),
                               size=3.5
                               ),
ncol = 2)
```


### Nrg1                    


```{r message=FALSE, warning=FALSE, fig.width=12, fig.height=7.6}
check.m <- "Nrg1"

#
cowplot::plot_grid(
VlnPlot(test1.seur, features = check.m, group.by = "intAnno1", assay = "RNA") + NoLegend() + labs(x="Stst") +
  scale_fill_manual(values = color.A1),

VlnPlot(test2.seur, features = check.m, group.by = "intAnno1", assay = "RNA") + NoLegend() + labs(x="CR7d") +
  scale_fill_manual(values = color.A1),

VlnPlot(test1.seur, features = check.m, group.by = "intAnno1", assay = "RNA", split.by = "cnt") + NoLegend() + labs(x="Stst") +
  scale_fill_manual(values = color.test1),

VlnPlot(test2.seur, features = check.m, group.by = "intAnno1", assay = "RNA", split.by = "cnt") + NoLegend() + labs(x="CR7d") +
  scale_fill_manual(values = color.test2),
#
ncol = 2)

```

```{r fig.height=13.5, fig.width=8, message=FALSE, warning=FALSE}
##
# use coord_cartesian(ylim()) instead of ylim()

cowplot::plot_grid(
VlnPlot(test1.seur, features = check.m, group.by = "cnt", cols = color.test1, pt.size = 0, assay = "RNA") + NoLegend() &
  geom_jitter(alpha=0.25, shape=16, width = 0.3, size = 0.25) & labs(title = paste0("All - ",check.m), x="") &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55) & coord_cartesian(ylim = c(0,6)) & 
  ggpubr::stat_compare_means(aes(lable = ..p.signif..), 
                               method = "wilcox.test",
                               comparisons = list(c("Stst.CTL","Stst.CKO")),
                               label.y = c(4.5),
                               size=3.5
                               ),

#
VlnPlot(subset(test1.seur, subset=intAnno1 %in% c("IN1")), features = check.m, group.by = "cnt", cols = color.test1, pt.size = 0, assay = "RNA") + NoLegend() &
  geom_jitter(alpha=0.25, shape=16, width = 0.3, size = 0.25) & labs(title = paste0("IN1 - ",check.m), x="") &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55) & coord_cartesian(ylim = c(0,6)) & 
  ggpubr::stat_compare_means(aes(lable = ..p.signif..), 
                               method = "wilcox.test",
                               comparisons = list(c("Stst.CTL","Stst.CKO")),
                               label.y = c(4.5),
                               size=3.5
                               ) ,

VlnPlot(subset(test1.seur, subset=intAnno1 %in% c("IN2")), features = check.m, group.by = "cnt", cols = color.test1, pt.size = 0, assay = "RNA") + NoLegend() &
  geom_jitter(alpha=0.25, shape=16, width = 0.3, size = 0.25) & labs(title = paste0("IN2 - ",check.m), x="") &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55) & coord_cartesian(ylim = c(0,6)) & 
  ggpubr::stat_compare_means(aes(lable = ..p.signif..), 
                               method = "wilcox.test",
                               comparisons = list(c("Stst.CTL","Stst.CKO")),
                               label.y = c(4),
                               size=3.5
                               ),
VlnPlot(subset(test1.seur, subset=intAnno1 %in% c("IN3")), features = check.m, group.by = "cnt", cols = color.test1, pt.size = 0, assay = "RNA") + NoLegend() &
  geom_jitter(alpha=0.25, shape=16, width = 0.3, size = 0.25) & labs(title = paste0("IN3 - ",check.m), x="") &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55) & coord_cartesian(ylim = c(0,6)) & 
  ggpubr::stat_compare_means(aes(lable = ..p.signif..), 
                               method = "wilcox.test",
                               comparisons = list(c("Stst.CTL","Stst.CKO")),
                               label.y = c(4),
                               size=3.5
                               ),

VlnPlot(subset(test1.seur, subset=intAnno1 %in% c("IPAN1")), features = check.m, group.by = "cnt", cols = color.test1, pt.size = 0, assay = "RNA") + NoLegend() &
  geom_jitter(alpha=0.25, shape=16, width = 0.3, size = 0.25) & labs(title = paste0("IPAN1 - ",check.m), x="") &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55) & coord_cartesian(ylim = c(0,6)) & 
  ggpubr::stat_compare_means(aes(lable = ..p.signif..), 
                               method = "wilcox.test",
                               comparisons = list(c("Stst.CTL","Stst.CKO")),
                               label.y = c(4.5),
                               size=3.5
                               ),
VlnPlot(subset(test1.seur, subset=intAnno1 %in% c("IMN4")), features = check.m, group.by = "cnt", cols = color.test1, pt.size = 0, assay = "RNA") + NoLegend() &
  geom_jitter(alpha=0.25, shape=16, width = 0.3, size = 0.25) & labs(title = paste0("IMN4 - ",check.m), x="") &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55) & coord_cartesian(ylim = c(0,6)) & 
  ggpubr::stat_compare_means(aes(lable = ..p.signif..), 
                               method = "wilcox.test",
                               comparisons = list(c("Stst.CTL","Stst.CKO")),
                               label.y = c(3.25),
                               size=3.5
                               ),
ncol = 2)
```

```{r message=FALSE, warning=FALSE, fig.width=8, fig.height=13.5}
##
# use coord_cartesian(ylim()) instead of ylim()

cowplot::plot_grid(
VlnPlot(test2.seur, features = check.m, group.by = "cnt", cols = color.test2, pt.size = 0, assay = "RNA") + NoLegend() &
  geom_jitter(alpha=0.25, shape=16, width = 0.3, size = 0.25) & labs(title = paste0("All - ",check.m), x="") &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55) & coord_cartesian(ylim = c(0,6)) & 
  ggpubr::stat_compare_means(aes(lable = ..p.signif..), 
                               method = "wilcox.test",
                               comparisons = list(c("CR7d.CTL","CR7d.CKO")),
                               label.y = c(4.5),
                               size=3.5
                               ),

#
VlnPlot(subset(test2.seur, subset=intAnno1 %in% c("IN1")), features = check.m, group.by = "cnt", cols = color.test2, pt.size = 0, assay = "RNA") + NoLegend() &
  geom_jitter(alpha=0.25, shape=16, width = 0.3, size = 0.25) & labs(title = paste0("IN1 - ",check.m), x="") &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55) & coord_cartesian(ylim = c(0,6)) & 
  ggpubr::stat_compare_means(aes(lable = ..p.signif..), 
                               method = "wilcox.test",
                               comparisons = list(c("CR7d.CTL","CR7d.CKO")),
                               label.y = c(4.5),
                               size=3.5
                               ) ,

VlnPlot(subset(test2.seur, subset=intAnno1 %in% c("IN2")), features = check.m, group.by = "cnt", cols = color.test2, pt.size = 0, assay = "RNA") + NoLegend() &
  geom_jitter(alpha=0.25, shape=16, width = 0.3, size = 0.25) & labs(title = paste0("IN2 - ",check.m), x="") &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55) & coord_cartesian(ylim = c(0,6)) & 
  ggpubr::stat_compare_means(aes(lable = ..p.signif..), 
                               method = "wilcox.test",
                               comparisons = list(c("CR7d.CTL","CR7d.CKO")),
                               label.y = c(4),
                               size=3.5
                               ),
VlnPlot(subset(test2.seur, subset=intAnno1 %in% c("IN3")), features = check.m, group.by = "cnt", cols = color.test2, pt.size = 0, assay = "RNA") + NoLegend() &
  geom_jitter(alpha=0.25, shape=16, width = 0.3, size = 0.25) & labs(title = paste0("IN3 - ",check.m), x="") &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55) & coord_cartesian(ylim = c(0,6)) & 
  ggpubr::stat_compare_means(aes(lable = ..p.signif..), 
                               method = "wilcox.test",
                               comparisons = list(c("CR7d.CTL","CR7d.CKO")),
                               label.y = c(4),
                               size=3.5
                               ),

VlnPlot(subset(test2.seur, subset=intAnno1 %in% c("IPAN1")), features = check.m, group.by = "cnt", cols = color.test2, pt.size = 0, assay = "RNA") + NoLegend() &
  geom_jitter(alpha=0.25, shape=16, width = 0.3, size = 0.25) & labs(title = paste0("IPAN1 - ",check.m), x="") &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55) & coord_cartesian(ylim = c(0,6)) & 
  ggpubr::stat_compare_means(aes(lable = ..p.signif..), 
                               method = "wilcox.test",
                               comparisons = list(c("CR7d.CTL","CR7d.CKO")),
                               label.y = c(4.5),
                               size=3.5
                               ),
VlnPlot(subset(test2.seur, subset=intAnno1 %in% c("IMN4")), features = check.m, group.by = "cnt", cols = color.test2, pt.size = 0, assay = "RNA") + NoLegend() &
  geom_jitter(alpha=0.25, shape=16, width = 0.3, size = 0.25) & labs(title = paste0("IMN4 - ",check.m), x="") &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55) & coord_cartesian(ylim = c(0,6)) & 
  ggpubr::stat_compare_means(aes(lable = ..p.signif..), 
                               method = "wilcox.test",
                               comparisons = list(c("CR7d.CTL","CR7d.CKO")),
                               label.y = c(3.25),
                               size=3.5
                               ),
ncol = 2)
```


## check202409              
        
### check markers                
        
```{r}
check.markers.ref <- c("Chat","Bnc2","Penk","Fut9",
                       "Tac1","Ahr","Nos1","Etv1",
                       "Vip","Gal","Moxd1","Sctr",
                       "Piezo1","Sst","Calb2","Calcb",
                       "Nmu","Cdh8","Cdh9","Cck",
                       "Piezo2","Nxph2")
```

```{r}
length(check.markers.ref)
```


```{r fig.width=13.5, fig.height=25}
vln.check <- VlnPlot(GEX.seur, features = check.markers.ref, cols = color.A1,
                    assay = "RNA", group.by = "intAnno1", ncol = 2, pt.size = 0.01) &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55)
vln.check
``` 


```{r fig.width=13.5, fig.height=25}
vln.check.s <- VlnPlot(GEX.seur, features = check.markers.ref, cols = color.A1,
                    assay = "RNA", group.by = "intAnno1", ncol = 2, pt.size = 0) &
    geom_boxplot(outlier.size = 0, fill="white", width=0.2, size=0.1, alpha=0.55) &
    stat_summary(fun=mean, geom="point", shape=18, size=3, color="black", alpha=0.55)
vln.check.s
``` 


```{r eval=FALSE, include=FALSE}
ggsave("./figures.integration/violin.check_markers.SI_CR7d.pdf",
       width = 13.5, height = 25,
       plot = vln.check)

ggsave("./figures.integration/violin.check_markers.SI_CR7d.s.pdf",
       width = 13.5, height = 25,
       plot = vln.check.s)
```




























